!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class t{constructor(){if(t.instance)return t.instance;this.context=null,this.stream=null,this.analyser=null,this.source=null,this.gainNode=null,this.isInitialized=!1,this.listeners=new Map,this.deviceChangeListener=null,t.instance=this}async initialize(){try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return{success:!1,error:"WEB_AUDIO_UNSUPPORTED"};this.context=new t,"suspended"===this.context.state&&console.warn("AudioContext suspended. Waiting for user gesture to resume.");const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:{ideal:44100},channelCount:1}});return this.stream=e,this.source=this.context.createMediaStreamSource(e),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=0,this.gainNode=this.context.createGain(),this.gainNode.gain.value=1,this.source.connect(this.gainNode),this.gainNode.connect(this.analyser),this.setupDeviceChangeMonitoring(),this.isInitialized=!0,{success:!0,sampleRate:this.context.sampleRate}}catch(t){return{success:!1,error:this.categorizeError(t)}}}async resume(){if(!this.context)return!1;if("suspended"===this.context.state)try{return await this.context.resume(),"running"===this.context.state}catch(t){return console.error("Failed to resume AudioContext:",t),!1}return"running"===this.context.state}getAudioData(){if(!this.analyser||!this.isInitialized)return new Float32Array(0);const t=this.analyser.fftSize,e=new Float32Array(t);return this.analyser.getFloatTimeDomainData(e),e}getVolumeLevel(){const t=this.getAudioData();if(0===t.length)return 0;let e=0;for(let i=0;i<t.length;i++)e+=t[i]*t[i];const s=Math.sqrt(e/t.length);return Math.min(10*s,1)}setupDeviceChangeMonitoring(){if(!this.stream)return;this.stream.getTracks().forEach(t=>{t.addEventListener("ended",()=>{this.emit("device-disconnected",{deviceId:t.id})})}),this.deviceChangeListener=()=>{this.emit("device-changed")},navigator.mediaDevices.addEventListener("devicechange",this.deviceChangeListener)}categorizeError(t){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?"NotAllowedError"===t.name||"PermissionDeniedError"===t.name?"PERMISSION_DENIED":"NotFoundError"===t.name||"DevicesNotFoundError"===t.name?"NO_MICROPHONE":"NotReadableError"===t.name||"TrackStartError"===t.name?"DEVICE_IN_USE":"OverconstrainedError"===t.name?"CONSTRAINTS_NOT_SATISFIED":"TypeError"===t.name?"TYPE_ERROR":"UNKNOWN_ERROR":"NO_MEDIA_DEVICES"}getState(){return this.context?this.context.state:"not-initialized"}getSampleRate(){return this.context?this.context.sampleRate:0}async playReferenceTone(t,e=1){if(!this.context)throw new Error("AudioContext not initialized");await this.resume();const s=this.context.createOscillator(),i=this.context.createGain();s.type="sine",s.frequency.value=t;const o=this.context.currentTime;return i.gain.setValueAtTime(0,o),i.gain.linearRampToValueAtTime(.3,o+.01),i.gain.linearRampToValueAtTime(.3,o+e-.01),i.gain.linearRampToValueAtTime(0,o+e),s.connect(i),i.connect(this.context.destination),s.start(o),s.stop(o+e),new Promise(t=>{s.onended=t})}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!this.listeners.has(t))return;const s=this.listeners.get(t),i=s.indexOf(e);i>-1&&s.splice(i,1)}emit(t,e){if(!this.listeners.has(t))return;this.listeners.get(t).forEach(s=>{try{s(e)}catch(i){console.error(`Error in event listener for ${t}:`,i)}})}async destroy(){this.deviceChangeListener&&(navigator.mediaDevices.removeEventListener("devicechange",this.deviceChangeListener),this.deviceChangeListener=null),this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.source&&(this.source.disconnect(),this.source=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.analyser&&(this.analyser=null),this.context&&"closed"!==this.context.state&&(await this.context.close(),this.context=null),this.isInitialized=!1,this.listeners.clear(),t.instance=null}static getInstance(){return t.instance?t.instance:new t}}const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(t){return t<=0?0:12*Math.log2(t/440)+69}function i(t){return 440*2**((t-69)/12)}function o(t){if(t<=0)return{note:null,frequency:0,targetFrequency:0,cents:0,midi:0};const o=s(t),n=Math.round(o),a=100*(o-n),r=i(n);return{note:function(t){const s=Math.round(t),i=Math.floor(s/12)-1;return`${e[s%12]}${i}`}(n),frequency:t,targetFrequency:r,cents:Math.round(10*a)/10,midi:n}}function n(t,o,n=25){const a=function(t){const s=t.match(/^([A-G]#?)(-?\d+)$/);if(!s)throw new Error(`Invalid note name: ${t}`);const i=s[1],o=parseInt(s[2],10),n=e.indexOf(i);if(-1===n)throw new Error(`Invalid note: ${i}`);return 12*(o+1)+n}(o),r=i(a),h=100*(s(t)-a);return{match:Math.abs(h)<=n,cents:Math.round(10*h)/10,targetFrequency:r}}class a{constructor(t){this.audioContextManager=t,this.worker=null,this.isInitialized=!1,this.messageId=0,this.pendingRequests=new Map,this.lastResult=null}async init(){return new Promise((t,e)=>{try{this.worker=new Worker(new URL("/scale-climber/assets/PitchDetector.worker-BSdwUMKd.js",import.meta.url),{type:"module"}),this.worker.onmessage=t=>{this.handleWorkerMessage(t.data)},this.worker.onerror=t=>{console.error("PitchDetector Worker Error:",t)};const s=this.audioContextManager.getSampleRate();this.worker.postMessage({type:"init",data:{sampleRate:s,bufferSize:1024,yinThreshold:.15}});const i=e=>{"initialized"===e.data.type&&(this.isInitialized=!0,this.worker.removeEventListener("message",i),t())};this.worker.addEventListener("message",i),setTimeout(()=>{this.isInitialized||e(new Error("Worker initialization timeout"))},5e3)}catch(s){e(s)}})}handleWorkerMessage(t){const{type:e,id:s,data:i}=t;switch(e){case"result":if(this.pendingRequests.has(s)){const{resolve:t}=this.pendingRequests.get(s);this.pendingRequests.delete(s);let e=i;if(i.frequency){const t=o(i.frequency);e={...i,...t}}else e={...i,note:null,cents:0,targetFrequency:0,midi:0};this.lastResult=e,t(e)}break;case"initialized":case"config-updated":break;default:console.warn(`Unknown worker message type: ${e}`)}}async detect(){if(!this.isInitialized)throw new Error("PitchDetector not initialized. Call init() first.");return new Promise((t,e)=>{try{const s=this.audioContextManager.getAudioData();if(0===s.length)return void t({frequency:null,note:null,cents:0,confidence:0,clarity:0,volume:0,targetFrequency:0,midi:0});const i=this.messageId++;this.pendingRequests.set(i,{resolve:t,reject:e});const o=new Float32Array(s);this.worker.postMessage({type:"process",id:i,data:{buffer:o}},[o.buffer]),setTimeout(()=>{this.pendingRequests.has(i)&&(this.pendingRequests.delete(i),e(new Error("Pitch detection timeout")))},1e3)}catch(s){e(s)}})}getLastResult(){return this.lastResult}updateConfig(t){this.worker&&this.worker.postMessage({type:"update-config",data:t})}isReady(){return this.isInitialized&&null!==this.worker}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingRequests.clear(),this.isInitialized=!1,this.lastResult=null}}class r{constructor(t){this.pitchDetector=t,this.state="idle",this.volumeSamples=[],this.pitchSamples=[],this.result=null,this.onProgressCallback=null}async start(t){this.reset(),this.onProgressCallback=t;try{this.state="volume_test",this.reportProgress(0,"Testing microphone volume..."),await this.runVolumeTest(3e3);return this.volumeSamples.reduce((t,e)=>t+e,0)/this.volumeSamples.length<.05?{success:!1,error:"VOLUME_TOO_LOW",message:"Microphone not detecting sound. Please speak or sing louder."}:(this.state="range_detect",this.reportProgress(.3,"Detecting vocal range... Sing from low to high notes"),await this.runRangeDetection(1e4),this.pitchSamples.length<10?{success:!1,error:"INSUFFICIENT_DATA",message:"Not enough pitch data. Please sing more notes."}:(this.state="analysis",this.reportProgress(.9,"Analyzing results..."),this.result=this.analyzeResults(),this.state="complete",this.reportProgress(1,"Calibration complete!"),{success:!0,...this.result}))}catch(e){return console.error("Calibration error:",e),{success:!1,error:"CALIBRATION_FAILED",message:e.message}}}async runVolumeTest(t){const e=Date.now();for(;Date.now()-e<t;){const s=await this.pitchDetector.detect();this.volumeSamples.push(s.volume);const i=(Date.now()-e)/t;this.reportProgress(.3*i,"Testing microphone volume..."),await this.sleep(100)}}async runRangeDetection(t){const e=Date.now();for(;Date.now()-e<t;){const s=await this.pitchDetector.detect();s.frequency&&s.confidence>.7&&s.volume>.1&&this.pitchSamples.push({frequency:s.frequency,note:s.note,midi:s.midi,confidence:s.confidence});const i=.3+(Date.now()-e)/t*.6,o=Math.ceil((t-(Date.now()-e))/1e3);this.reportProgress(i,`Sing from low to high... (${o}s remaining)`),await this.sleep(200)}}analyzeResults(){const t=this.pitchSamples.map(t=>t.midi),e=Math.min(...t),s=Math.max(...t),i=this.pitchSamples.find(t=>t.midi===e),o=this.pitchSamples.find(t=>t.midi===s),n=(e+s)/2;let a,r;return n<50?(a="Bass",r=3):n<57?(a="Baritone",r=3):n<64?(a="Tenor",r=4):n<72?(a="Alto",r=4):(a="Soprano",r=4),{lowestNote:i.note,highestNote:o.note,lowestMidi:e,highestMidi:s,recommendedOctave:r,voiceType:a}}reportProgress(t,e){this.onProgressCallback&&this.onProgressCallback(this.state,t,e)}sleep(t){return new Promise(e=>setTimeout(e,t))}reset(){this.state="idle",this.volumeSamples=[],this.pitchSamples=[],this.result=null}getState(){return this.state}getResult(){return this.result}}const h={easy:{tolerance:50,holdTime:1200,maxAttempts:5},normal:{tolerance:25,holdTime:1500,maxAttempts:3},hard:{tolerance:10,holdTime:1800,maxAttempts:3}};class l{constructor(t){var e;this.config={octave:t.octave||4,difficulty:t.difficulty||"normal",onNoteHit:t.onNoteHit||(()=>{}),onNoteMiss:t.onNoteMiss||(()=>{}),onComplete:t.onComplete||(()=>{}),onFail:t.onFail||(()=>{}),onProgress:t.onProgress||(()=>{})},this.scale=[`C${e=this.config.octave}`,`D${e}`,`E${e}`,`F${e}`,`G${e}`,`A${e}`,`B${e}`,`C${e+1}`],this.difficultySettings=h[this.config.difficulty],this.currentNoteIndex=0,this.currentNoteAttempts=0,this.totalAttempts=0,this.startTime=null,this.noteStartTime=null,this.holdStartTime=null,this.holdSamples=[],this.isHolding=!1,this.failureCount=0,this.state="ready"}start(){this.startTime=Date.now(),this.noteStartTime=Date.now(),this.state="active",this.emitProgress()}update(t){if("active"!==this.state)return{stateChanged:!1};if(Date.now()-this.startTime>12e4)return this.fail("TIME_LIMIT_EXCEEDED"),{stateChanged:!0,newState:"failed"};const e=this.scale[this.currentNoteIndex];if(t.frequency&&t.confidence>.7){const s=n(t.frequency,e,this.difficultySettings.tolerance);return s.match?this.handleNoteMatch(t,s):this.handleNoteOff()}return this.handleNoteOff()}handleNoteMatch(t,e){this.isHolding||(this.isHolding=!0,this.holdStartTime=Date.now(),this.holdSamples=[]),this.holdSamples.push({cents:e.cents,confidence:t.confidence,timestamp:Date.now()});return Date.now()-this.holdStartTime>=this.difficultySettings.holdTime?this.completeNote():{stateChanged:!1}}handleNoteOff(){return this.isHolding&&(this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[]),{stateChanged:!1}}completeNote(){const t=this.holdSamples.length>0?this.holdSamples.reduce((t,e)=>t+e.cents,0)/this.holdSamples.length:0,e=Date.now()-this.noteStartTime;return this.config.onNoteHit({noteIndex:this.currentNoteIndex,note:this.scale[this.currentNoteIndex],averageCents:t,timeToHit:e,holdDuration:this.holdSamples.length>0?this.holdSamples[this.holdSamples.length-1].timestamp-this.holdSamples[0].timestamp:0,attempts:this.currentNoteAttempts+1}),this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.currentNoteIndex++,this.currentNoteAttempts=0,this.noteStartTime=Date.now(),this.currentNoteIndex>=this.scale.length?(this.state="complete",this.config.onComplete(),{stateChanged:!0,newState:"complete",noteCompleted:!0}):(this.emitProgress(),{stateChanged:!1,noteCompleted:!0})}recordFailedAttempt(){this.currentNoteAttempts++,this.totalAttempts++,this.currentNoteAttempts>=this.difficultySettings.maxAttempts&&(this.failureCount++,this.config.onNoteMiss({noteIndex:this.currentNoteIndex,note:this.scale[this.currentNoteIndex],attempts:this.currentNoteAttempts}),this.failureCount>=3?this.fail("TOO_MANY_FAILURES"):(this.currentNoteIndex++,this.currentNoteAttempts=0,this.noteStartTime=Date.now(),this.currentNoteIndex>=this.scale.length?(this.state="complete",this.config.onComplete()):this.emitProgress()))}fail(t){this.state="failed",this.config.onFail(t)}emitProgress(){this.config.onProgress({currentNoteIndex:this.currentNoteIndex,totalNotes:this.scale.length,currentNote:this.scale[this.currentNoteIndex],progress:this.currentNoteIndex/this.scale.length})}getState(){return this.state}getCurrentNote(){return this.currentNoteIndex>=this.scale.length?null:this.scale[this.currentNoteIndex]}getHoldProgress(){if(!this.isHolding||!this.holdStartTime)return 0;const t=Date.now()-this.holdStartTime;return Math.min(t/this.difficultySettings.holdTime,1)}getStateForPersistence(){return{currentNoteIndex:this.currentNoteIndex,currentNoteAttempts:this.currentNoteAttempts,totalAttempts:this.totalAttempts,failureCount:this.failureCount,startTime:this.startTime,noteStartTime:this.noteStartTime,state:this.state}}restore(t){this.currentNoteIndex=t.currentNoteIndex||0,this.currentNoteAttempts=t.currentNoteAttempts||0,this.totalAttempts=t.totalAttempts||0,this.failureCount=t.failureCount||0,this.startTime=t.startTime||Date.now(),this.noteStartTime=t.noteStartTime||Date.now(),this.state=t.state||"ready"}getStatistics(){return{notesCompleted:this.currentNoteIndex,totalNotes:this.scale.length,totalAttempts:this.totalAttempts,failureCount:this.failureCount,timeElapsed:this.startTime?Date.now()-this.startTime:0,difficulty:this.config.difficulty,octave:this.config.octave}}}class c{constructor(t){this.config={targetNote:t.targetNote||"C4",tolerance:t.tolerance||25,holdTime:t.holdTime||1500,onNoteHit:t.onNoteHit||(()=>{}),onProgress:t.onProgress||(()=>{})},this.type="practice",this.attempts=0,this.successfulHits=0,this.totalHoldTime=0,this.bestAccuracy=null,this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.statistics={attempts:0,hits:0,totalCents:0,bestCents:null}}start(){}update(t){if(t.frequency&&t.confidence>.7){const e=n(t.frequency,this.config.targetNote,this.config.tolerance);return e.match?this.handleNoteMatch(t,e):this.handleNoteOff()}return this.handleNoteOff()}handleNoteMatch(t,e){this.isHolding||(this.isHolding=!0,this.holdStartTime=Date.now(),this.holdSamples=[],this.attempts++),this.holdSamples.push({cents:e.cents,confidence:t.confidence,timestamp:Date.now()}),this.config.onProgress({isHolding:!0,holdDuration:Date.now()-this.holdStartTime,requiredDuration:this.config.holdTime,progress:Math.min((Date.now()-this.holdStartTime)/this.config.holdTime,1),currentCents:e.cents});return Date.now()-this.holdStartTime>=this.config.holdTime?this.completeHold():{stateChanged:!1}}handleNoteOff(){return this.isHolding&&(this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.config.onProgress({isHolding:!1,holdDuration:0,requiredDuration:this.config.holdTime,progress:0})),{stateChanged:!1}}completeHold(){const t=this.holdSamples.length>0?this.holdSamples.reduce((t,e)=>t+e.cents,0)/this.holdSamples.length:0,e=Math.abs(t);return this.successfulHits++,this.totalHoldTime+=Date.now()-this.holdStartTime,this.statistics.hits++,this.statistics.totalCents+=e,(null===this.bestAccuracy||e<Math.abs(this.bestAccuracy))&&(this.bestAccuracy=t,this.statistics.bestCents=t),this.config.onNoteHit({note:this.config.targetNote,averageCents:t,holdDuration:Date.now()-this.holdStartTime,attempt:this.attempts}),this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.config.onProgress({isHolding:!1,holdDuration:0,requiredDuration:this.config.holdTime,progress:0}),{stateChanged:!1,noteCompleted:!0}}setTargetNote(t){this.config.targetNote=t,this.resetStatistics()}getTargetNote(){return this.config.targetNote}getHoldProgress(){if(!this.isHolding||!this.holdStartTime)return 0;const t=Date.now()-this.holdStartTime;return Math.min(t/this.config.holdTime,1)}getStatistics(){const t=this.attempts>0?this.successfulHits/this.attempts*100:0,e=this.successfulHits>0?this.statistics.totalCents/this.successfulHits:0;return{targetNote:this.config.targetNote,attempts:this.attempts,successfulHits:this.successfulHits,successRate:Math.round(t),averageAccuracy:Math.round(10*e)/10,bestAccuracy:null!==this.bestAccuracy?Math.round(10*Math.abs(this.bestAccuracy))/10:null,totalPracticeTime:this.totalHoldTime}}resetStatistics(){this.attempts=0,this.successfulHits=0,this.totalHoldTime=0,this.bestAccuracy=null,this.statistics={attempts:0,hits:0,totalCents:0,bestCents:null}}getStateForPersistence(){return{targetNote:this.config.targetNote,tolerance:this.config.tolerance,attempts:this.attempts,successfulHits:this.successfulHits,bestAccuracy:this.bestAccuracy,statistics:this.statistics}}restore(t){this.config.targetNote=t.targetNote||"C4",this.config.tolerance=t.tolerance||25,this.attempts=t.attempts||0,this.successfulHits=t.successfulHits||0,this.bestAccuracy=t.bestAccuracy||null,this.statistics=t.statistics||{attempts:0,hits:0,totalCents:0,bestCents:null}}getState(){return"active"}}const u=700,d=600,m=500,g=400,p=300,f={maxCents:10,points:100},y={maxCents:25,points:75},S={maxCents:50,points:50};class C{constructor(){this.notes=[],this.currentCombo=0,this.maxCombo=0,this.totalScore=0,this.perfectCount=0,this.greatCount=0,this.okCount=0,this.missCount=0}addNote(t,e,s){if(!s)return this.notes.push({tier:"MISS",points:0,comboBonus:0,totalPoints:0,avgCents:t,timeToHit:e}),this.missCount++,this.currentCombo=0,{tier:"MISS",points:0,comboBonus:0,totalPoints:0,combo:0};const i=Math.abs(t);let o,n;i<=f.maxCents?(o="PERFECT",n=f.points,this.perfectCount++):i<=y.maxCents?(o="GREAT",n=y.points,this.greatCount++):i<=S.maxCents?(o="OK",n=S.points,this.okCount++):(o="MISS",n=0,this.missCount++),"PERFECT"===o?(this.currentCombo++,this.maxCombo=Math.max(this.maxCombo,this.currentCombo)):this.currentCombo=0;const a=this.calculateComboBonus(this.currentCombo),r=this.calculateTimeBonus(e),h=n+a+r;return this.notes.push({tier:o,points:n,comboBonus:a,timeBonus:r,totalPoints:h,avgCents:t,timeToHit:e}),this.totalScore+=h,{tier:o,points:n,comboBonus:a,timeBonus:r,totalPoints:h,combo:this.currentCombo}}calculateComboBonus(t){return t<2?0:t<4?5:t<6?10:t<8?15:20}calculateTimeBonus(t){return t<2e3?10:t<3e3?5:0}getFinalScore(){return this.totalScore}getGrade(){return this.totalScore>=u?"S":this.totalScore>=d?"A":this.totalScore>=m?"B":this.totalScore>=g?"C":this.totalScore>=p?"D":"F"}getStatistics(){const t=this.notes.length,e=t>0?(this.perfectCount+this.greatCount+this.okCount)/t*100:0;return{totalScore:this.totalScore,grade:this.getGrade(),totalNotes:t,perfectCount:this.perfectCount,greatCount:this.greatCount,okCount:this.okCount,missCount:this.missCount,maxCombo:this.maxCombo,accuracy:Math.round(e),averageCents:this.getAverageCents()}}getAverageCents(){const t=this.notes.filter(t=>"MISS"!==t.tier);if(0===t.length)return 0;const e=t.reduce((t,e)=>t+Math.abs(e.avgCents),0);return Math.round(e/t.length*10)/10}getState(){return{notes:this.notes,currentCombo:this.currentCombo,maxCombo:this.maxCombo,totalScore:this.totalScore,perfectCount:this.perfectCount,greatCount:this.greatCount,okCount:this.okCount,missCount:this.missCount}}restore(t){this.notes=t.notes||[],this.currentCombo=t.currentCombo||0,this.maxCombo=t.maxCombo||0,this.totalScore=t.totalScore||0,this.perfectCount=t.perfectCount||0,this.greatCount=t.greatCount||0,this.okCount=t.okCount||0,this.missCount=t.missCount||0}reset(){this.notes=[],this.currentCombo=0,this.maxCombo=0,this.totalScore=0,this.perfectCount=0,this.greatCount=0,this.okCount=0,this.missCount=0}}const b="scale-climber-session",v="scale-climber-high-scores",w="scale-climber-settings";class M{constructor(){this.hasSessionStorage=this.checkStorageAvailability("sessionStorage"),this.hasLocalStorage=this.checkStorageAvailability("localStorage")}checkStorageAvailability(t){try{const e=window[t],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),!0}catch(e){return!1}}saveSession(t){if(!this.hasSessionStorage)return!1;try{const e={...t,timestamp:Date.now(),version:"1.0"};return sessionStorage.setItem(b,JSON.stringify(e)),!0}catch(e){return console.error("Failed to save session:",e),!1}}loadSession(){if(!this.hasSessionStorage)return null;try{const t=sessionStorage.getItem(b);if(!t)return null;const e=JSON.parse(t);return Date.now()-e.timestamp>36e5?(this.clearSession(),null):e.mode&&e.config?e:null}catch(t){return console.error("Failed to load session:",t),null}}clearSession(){if(this.hasSessionStorage)try{sessionStorage.removeItem(b)}catch(t){console.error("Failed to clear session:",t)}}hasSession(){if(!this.hasSessionStorage)return!1;return null!==this.loadSession()}saveHighScore(t,e,s={}){if(!this.hasLocalStorage)return!1;try{const i=this.getHighScores(),o={score:t,grade:e,timestamp:Date.now(),date:(new Date).toISOString(),...s};i.push(o),i.sort((t,e)=>e.score-t.score);const n=i.slice(0,10);return localStorage.setItem(v,JSON.stringify(n)),n.some(t=>t.timestamp===o.timestamp)}catch(i){return console.error("Failed to save high score:",i),!1}}getHighScores(){if(!this.hasLocalStorage)return[];try{const t=localStorage.getItem(v);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.error("Failed to load high scores:",t),[]}}getPersonalBest(){const t=this.getHighScores();return 0===t.length?0:t[0].score}clearHighScores(){if(this.hasLocalStorage)try{localStorage.removeItem(v)}catch(t){console.error("Failed to clear high scores:",t)}}saveSettings(t){if(this.hasLocalStorage)try{localStorage.setItem(w,JSON.stringify(t))}catch(e){console.error("Failed to save settings:",e)}}loadSettings(){if(!this.hasLocalStorage)return this.getDefaultSettings();try{const t=localStorage.getItem(w);if(!t)return this.getDefaultSettings();const e=JSON.parse(t);return{...this.getDefaultSettings(),...e}}catch(t){return console.error("Failed to load settings:",t),this.getDefaultSettings()}}getDefaultSettings(){return{volume:.7,difficulty:"normal",octave:4,showReferenceTone:!0,autoCalibrate:!0,theme:"dark"}}clearAll(){if(this.clearSession(),this.clearHighScores(),this.hasLocalStorage)try{localStorage.removeItem(w)}catch(t){console.error("Failed to clear settings:",t)}}getStorageInfo(){return{sessionStorage:this.hasSessionStorage,localStorage:this.hasLocalStorage,hasSession:this.hasSession(),highScoreCount:this.getHighScores().length,personalBest:this.getPersonalBest()}}}class T{constructor(){this.audioManager=null,this.pitchDetector=null,this.calibrationEngine=null,this.currentMode=null,this.scoreSystem=new C,this.stateRecovery=new M,this.state="idle",this.subState=null,this.currentNote=0,this.lastPitchResult=null,this.frameTime=0,this.listeners=new Map,this.gameLoopId=null,this.isPaused=!1}async initialize(){try{this.audioManager=t.getInstance();const e=await this.audioManager.initialize();return e.success?(this.pitchDetector=new a(this.audioManager),await this.pitchDetector.init(),this.calibrationEngine=new r(this.pitchDetector),{success:!0}):{success:!1,error:e.error}}catch(e){return{success:!1,error:"INITIALIZATION_FAILED",message:e.message}}}async startCalibration(t){this.state="calibration";const e=await this.calibrationEngine.start(t);return e.success?this.emit("calibration-complete",e):this.emit("calibration-failed",e),e}startChallenge(t=4,e="normal"){this.state="countdown",this.scoreSystem.reset(),this.currentMode=new l({octave:t,difficulty:e,onNoteHit:t=>this.handleNoteHit(t),onNoteMiss:t=>this.handleNoteMiss(t),onComplete:()=>this.handleChallengeComplete(),onFail:t=>this.handleChallengeFail(t),onProgress:t=>this.emit("challenge-progress",t)}),this.emit("countdown-start");let s=3;const i=setInterval(()=>{this.emit("countdown-tick",s),s--,s<0&&(clearInterval(i),this.state="playing",this.currentMode.start(),this.startGameLoop(),this.emit("game-start"))},1e3)}startPractice(t="C4",e="normal"){this.state="playing";this.currentMode=new c({targetNote:t,tolerance:{easy:50,normal:25,hard:10}[e],holdTime:1500,onNoteHit:t=>{this.emit("practice-note-hit",t)},onProgress:t=>{this.emit("practice-progress",t)}}),this.currentMode.start(),this.startGameLoop(),this.emit("practice-start",{targetNote:t})}async startGameLoop(){const t=async()=>{if("playing"!==this.state||this.isPaused)return;const e=performance.now();try{if(this.lastPitchResult=await this.pitchDetector.detect(),this.currentMode){const t=this.currentMode.update(this.lastPitchResult);t.stateChanged&&(this.subState=t.newState),t.noteCompleted&&this.emit("note-completed",{currentNote:this.currentMode.getCurrentNote?.(),holdProgress:this.currentMode.getHoldProgress?.()||0})}this.emit("pitch-update",{...this.lastPitchResult,targetNote:this.currentMode?.getCurrentNote?.()||null,holdProgress:this.currentMode?.getHoldProgress?.()||0}),"practice"!==this.currentMode?.type&&e%5e3<16&&this.saveGameState()}catch(s){console.error("Game loop error:",s)}this.frameTime=performance.now()-e,this.gameLoopId=requestAnimationFrame(t)};this.gameLoopId=requestAnimationFrame(t)}stopGameLoop(){this.gameLoopId&&(cancelAnimationFrame(this.gameLoopId),this.gameLoopId=null)}handleNoteHit(t){const e=this.scoreSystem.addNote(t.averageCents,t.timeToHit,!0);this.currentNote++,this.emit("note-hit",{noteData:t,score:e})}handleNoteMiss(t){this.scoreSystem.addNote(0,0,!1),this.emit("note-miss",{noteData:t})}handleChallengeComplete(){this.state="complete",this.stopGameLoop();const t=this.scoreSystem.getFinalScore(),e=this.scoreSystem.getGrade(),s=this.scoreSystem.getStatistics();this.stateRecovery.saveHighScore(t,e,{...s,mode:"challenge",octave:this.currentMode.config.octave,difficulty:this.currentMode.config.difficulty}),this.stateRecovery.clearSession(),this.emit("challenge-complete",{finalScore:t,grade:e,statistics:s})}handleChallengeFail(t){this.state="failed",this.stopGameLoop(),this.stateRecovery.clearSession(),this.emit("challenge-failed",{reason:t})}pause(){"playing"===this.state&&(this.isPaused=!0,this.state="paused",this.saveGameState(),this.emit("game-paused"))}resume(){"paused"===this.state&&(this.isPaused=!1,this.state="playing",this.startGameLoop(),this.emit("game-resumed"))}stop(){this.stopGameLoop(),this.state="idle",this.currentMode=null,this.emit("game-stopped")}saveGameState(){this.currentMode&&"practice"!==this.currentMode.type&&this.stateRecovery.saveSession({mode:"challenge",modeState:this.currentMode.getStateForPersistence(),score:this.scoreSystem.getState(),currentNote:this.currentNote,config:this.currentMode.config,timestamp:Date.now()})}hasSavedSession(){return this.stateRecovery.hasSession()}async resumeSession(){const t=this.stateRecovery.loadSession();return t?("challenge"===t.mode&&(this.currentMode=new l(t.config),this.currentMode.restore(t.modeState)),this.scoreSystem.restore(t.score),this.currentNote=t.currentNote,this.state="playing",this.startGameLoop(),{success:!0}):{success:!1,error:"NO_SAVED_SESSION"}}getState(){return this.state}getLastPitchResult(){return this.lastPitchResult}getCurrentScore(){return this.scoreSystem.getFinalScore()}getScoreStatistics(){return this.scoreSystem.getStatistics()}getHighScores(){return this.stateRecovery.getHighScores()}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!this.listeners.has(t))return;const s=this.listeners.get(t),i=s.indexOf(e);i>-1&&s.splice(i,1)}emit(t,e){if(!this.listeners.has(t))return;this.listeners.get(t).forEach(s=>{try{s(e)}catch(i){console.error(`Error in event listener for ${t}:`,i)}})}async destroy(){this.stopGameLoop(),this.pitchDetector&&this.pitchDetector.destroy(),this.audioManager&&await this.audioManager.destroy(),this.listeners.clear()}}class x{constructor(){this.frameTimes=[],this.maxSamples=60,this.qualityLevel="high",this.thresholds={high:16.6,medium:20,low:33.3},this.listeners=new Map,this.isMonitoring=!1,this.lastFrameTime=0}start(){this.isMonitoring=!0,this.lastFrameTime=performance.now()}stop(){this.isMonitoring=!1,this.frameTimes=[]}recordFrame(t,e){if(!this.isMonitoring)return;const s=e-t;this.frameTimes.push(s),this.frameTimes.length>this.maxSamples&&this.frameTimes.shift(),this.frameTimes.length===this.maxSamples&&this.adjustQuality()}adjustQuality(){const t=this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length,e=this.qualityLevel;t>this.thresholds.medium&&"high"===this.qualityLevel?(this.qualityLevel="medium",console.warn(`Reducing quality to medium (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"medium",avgFrameTime:t})):t>this.thresholds.low&&"medium"===this.qualityLevel?(this.qualityLevel="low",console.warn(`Reducing quality to low (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"low",avgFrameTime:t})):t<.9*this.thresholds.high&&"medium"===this.qualityLevel?(this.qualityLevel="high",console.log(`Improving quality to high (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"high",avgFrameTime:t})):t<.9*this.thresholds.medium&&"low"===this.qualityLevel&&(this.qualityLevel="medium",console.log(`Improving quality to medium (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"medium",avgFrameTime:t})),this.frameTimes=[]}getQualityLevel(){return this.qualityLevel}setQualityLevel(t){if(["high","medium","low"].includes(t)){const e=this.qualityLevel;this.qualityLevel=t,this.frameTimes=[],this.emit("qualityChanged",{from:e,to:t,manual:!0})}}getQualitySettings(){return{high:{particlesEnabled:!0,particleCount:50,shadowsEnabled:!0,animationSmoothing:!0,backgroundLayers:3},medium:{particlesEnabled:!0,particleCount:25,shadowsEnabled:!1,animationSmoothing:!0,backgroundLayers:2},low:{particlesEnabled:!1,particleCount:0,shadowsEnabled:!1,animationSmoothing:!1,backgroundLayers:1}}[this.qualityLevel]}getStatistics(){if(0===this.frameTimes.length)return{avgFrameTime:0,minFrameTime:0,maxFrameTime:0,fps:0,qualityLevel:this.qualityLevel};const t=this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length,e=Math.min(...this.frameTimes),s=Math.max(...this.frameTimes),i=1e3/t;return{avgFrameTime:Math.round(100*t)/100,minFrameTime:Math.round(100*e)/100,maxFrameTime:Math.round(100*s)/100,fps:Math.round(i),qualityLevel:this.qualityLevel,sampleCount:this.frameTimes.length}}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!this.listeners.has(t))return;const s=this.listeners.get(t),i=s.indexOf(e);i>-1&&s.splice(i,1)}emit(t,e){if(!this.listeners.has(t))return;this.listeners.get(t).forEach(s=>{try{s(e)}catch(i){console.error(`Error in PerformanceMonitor listener for ${t}:`,i)}})}reset(){this.frameTimes=[],this.qualityLevel="high"}}class A{constructor(t){this.canvas=t,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!1}),this.performanceMonitor=new x,this.isRendering=!1,this.renderLoopId=null,this.character=null,this.pitchMeter=null,this.particleSystem=null,this.gameState={currentNote:null,targetNote:null,pitchData:null,score:0,combo:0,noteResult:null},this.setupCanvas(),this.setupPerformanceMonitoring()}setupCanvas(){this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.parentElement,e=t.clientWidth,s=t.clientHeight,i=16/9;let o=e,n=o/i;n>s&&(n=s,o=n*i),this.canvas.style.width=`${o}px`,this.canvas.style.height=`${n}px`;const a=window.devicePixelRatio||1;this.canvas.width=o*a,this.canvas.height=n*a,this.ctx.scale(a,a),this.width=o,this.height=n}setupPerformanceMonitoring(){this.performanceMonitor.on("qualityChanged",t=>{console.log(`Quality changed: ${t.from} → ${t.to}`);const e=this.performanceMonitor.getQualitySettings();this.particleSystem&&(this.particleSystem.setEnabled(e.particlesEnabled),this.particleSystem.setMaxParticles(e.particleCount)),this.character&&this.character.setAnimationSmoothing(e.animationSmoothing)})}setComponents(t){this.character=t.character,this.pitchMeter=t.pitchMeter,this.particleSystem=t.particleSystem}updateGameState(t){this.gameState={...this.gameState,...t},this.character&&this.character.updateState(t),this.pitchMeter&&this.pitchMeter.updateState(t),this.particleSystem&&t.noteResult&&this.particleSystem.emitForResult(t.noteResult,this.width/2,this.height/2)}start(){this.isRendering=!0,this.performanceMonitor.start(),this.renderLoop()}stop(){this.isRendering=!1,this.performanceMonitor.stop(),this.renderLoopId&&(cancelAnimationFrame(this.renderLoopId),this.renderLoopId=null)}renderLoop(){if(!this.isRendering)return;const t=performance.now();this.ctx.clearRect(0,0,this.width,this.height),this.renderBackground(),this.character&&this.character.render(this.ctx,this.width,this.height),this.pitchMeter&&this.pitchMeter.render(this.ctx,this.width,this.height),this.particleSystem&&(this.particleSystem.update(),this.particleSystem.render(this.ctx)),this.renderHUD();const e=performance.now();this.performanceMonitor.recordFrame(t,e),this.renderLoopId=requestAnimationFrame(()=>this.renderLoop())}renderBackground(){const t=this.ctx.createLinearGradient(0,0,0,this.height);t.addColorStop(0,"#87CEEB"),t.addColorStop(1,"#E0F6FF"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height);this.performanceMonitor.getQualitySettings().backgroundLayers>=2&&this.renderMountains()}renderMountains(){this.ctx.fillStyle="#8B7BB8",this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.moveTo(0,this.height),this.ctx.lineTo(.3*this.width,.6*this.height),this.ctx.lineTo(.5*this.width,this.height),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(.4*this.width,this.height),this.ctx.lineTo(.7*this.width,.5*this.height),this.ctx.lineTo(this.width,this.height),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=1}renderHUD(){const t=20;this.ctx.font="20px sans-serif",this.ctx.fillStyle="#2C3E50",this.ctx.textAlign="left",this.ctx.fillText(`Score: ${this.gameState.score}`,t,40),this.gameState.combo>0&&(this.ctx.fillStyle="#FFD700",this.ctx.fillText(`Combo: ${this.gameState.combo}x`,t,70));const e=this.performanceMonitor.getStatistics();this.ctx.textAlign="right",this.ctx.fillStyle="#7F8C8D",this.ctx.font="14px monospace",this.ctx.fillText(`${e.fps} FPS (${e.qualityLevel})`,this.width-t,34)}getPerformanceStats(){return this.performanceMonitor.getStatistics()}setQualityLevel(t){this.performanceMonitor.setQualityLevel(t)}destroy(){this.stop(),window.removeEventListener("resize",()=>this.resize())}}class F{constructor(){this.x=0,this.y=0,this.width=80,this.height=100,this.currentAnimation="idle",this.animationFrame=0,this.animationSpeed=.2,this.animationSmoothing=!0,this.noteProgress=0,this.lastNoteResult=null}updateState(t){t.noteResult&&(this.lastNoteResult=t.noteResult,"PERFECT"===t.noteResult||"GREAT"===t.noteResult?(this.currentAnimation="celebrating",setTimeout(()=>{this.currentAnimation="idle"},500)):"MISS"===t.noteResult&&(this.currentAnimation="stumbling",setTimeout(()=>{this.currentAnimation="idle"},500))),void 0!==t.holdProgress&&(this.noteProgress=t.holdProgress,this.noteProgress>0&&this.noteProgress<1&&(this.currentAnimation="climbing"))}render(t,e,s){switch(this.x=.3*e,this.y=.6*s,this.animationSmoothing&&(this.animationFrame+=this.animationSpeed,this.animationFrame>=4&&(this.animationFrame=0)),this.currentAnimation){case"climbing":this.renderClimbing(t);break;case"celebrating":this.renderCelebrating(t);break;case"stumbling":this.renderStumbling(t);break;default:this.renderIdle(t)}}renderIdle(t){const e=3*Math.sin(this.animationFrame);t.save(),t.translate(this.x,this.y+e),t.fillStyle="#20B2AA",t.beginPath(),t.arc(0,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"happy"),t.restore()}renderClimbing(t){const e=5*Math.sin(2*this.animationFrame);t.save(),t.translate(this.x,this.y),t.rotate(-.1),t.fillStyle="#20B2AA",t.beginPath(),t.arc(e,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"focused"),t.strokeStyle="#1A9B94",t.lineWidth=8,t.lineCap="round",t.beginPath(),t.moveTo(-15,-10),t.lineTo(-25,-30),t.stroke(),t.beginPath(),t.moveTo(15,-10),t.lineTo(25,-30),t.stroke(),t.restore()}renderCelebrating(t){const e=20*Math.abs(Math.sin(3*this.animationFrame));t.save(),t.translate(this.x,this.y-e);const s=1+.1*Math.sin(2*this.animationFrame);t.scale(s,s),t.fillStyle="#20B2AA",t.beginPath(),t.arc(0,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"excited"),t.strokeStyle="#1A9B94",t.lineWidth=8,t.lineCap="round",t.beginPath(),t.moveTo(-15,0),t.lineTo(-30,-20),t.stroke(),t.beginPath(),t.moveTo(15,0),t.lineTo(30,-20),t.stroke(),t.restore()}renderStumbling(t){const e=.3*Math.sin(5*this.animationFrame);t.save(),t.translate(this.x,this.y),t.rotate(e),t.fillStyle="#20B2AA",t.beginPath(),t.arc(0,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"worried"),t.restore()}renderFace(t,e){t.fillStyle="#2C3E50";const s=-5,i=12;"excited"===e?(t.beginPath(),t.arc(-12,s,4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(i,s,4,0,2*Math.PI),t.fill(),t.fillStyle="#FFD700",t.fillRect(-14,-11,2,2),t.fillRect(16,-11,2,2)):"worried"===e?(t.beginPath(),t.arc(-12,s,5,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(i,s,5,0,2*Math.PI),t.fill()):(t.beginPath(),t.arc(-12,s,3,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(i,s,3,0,2*Math.PI),t.fill()),t.strokeStyle="#2C3E50",t.lineWidth=2,t.lineCap="round",t.beginPath(),"excited"===e||"happy"===e?t.arc(0,5,12,.2,Math.PI-.2):"worried"===e?t.arc(0,15,12,Math.PI+.2,2*Math.PI-.2):(t.moveTo(-8,10),t.lineTo(8,10)),t.stroke()}setAnimationSmoothing(t){this.animationSmoothing=t}getCurrentAnimation(){return this.currentAnimation}}class E{constructor(){this.targetNote=null,this.currentFrequency=null,this.centDeviation=0,this.confidence=0,this.width=300,this.height=80,this.x=0,this.y=0}updateState(t){t.targetNote&&(this.targetNote=t.targetNote),t.pitchData&&(this.currentFrequency=t.pitchData.frequency,this.centDeviation=t.pitchData.cents||0,this.confidence=t.pitchData.confidence||0)}render(t,e,s){this.x=(e-this.width)/2,this.y=s-this.height-40,t.save(),t.translate(this.x,this.y),t.fillStyle="rgba(255, 255, 255, 0.9)",t.fillRect(0,0,this.width,this.height),t.strokeStyle="#2C3E50",t.lineWidth=2,t.strokeRect(0,0,this.width,this.height),this.targetNote&&(t.fillStyle="#2C3E50",t.font="bold 18px sans-serif",t.textAlign="center",t.fillText(`Target: ${this.targetNote}`,this.width/2,25)),this.renderCentMeter(t),this.confidence>0&&this.renderConfidence(t),t.restore()}renderCentMeter(t){const e=40,s=20,i=this.width/2;t.fillStyle="#E0E0E0",t.fillRect(20,e,this.width-40,s),t.strokeStyle="#2C3E50",t.lineWidth=2,t.beginPath(),t.moveTo(i,e),t.lineTo(i,60),t.stroke();const o=(this.width-40)/100,n=10*o;t.fillStyle="rgba(255, 215, 0, 0.3)",t.fillRect(i-n,e,2*n,s);const a=25*o;if(t.fillStyle="rgba(50, 205, 50, 0.2)",t.fillRect(i-a,e,2*a,s),this.confidence>.5){const e=i+Math.max(-50,Math.min(50,this.centDeviation))*o;let s="#FF4444";Math.abs(this.centDeviation)<=10?s="#FFD700":Math.abs(this.centDeviation)<=25?s="#32CD32":Math.abs(this.centDeviation)<=50&&(s="#00BFFF"),t.fillStyle=s,t.beginPath(),t.arc(e,50,8,0,2*Math.PI),t.fill(),t.fillStyle="#2C3E50",t.font="12px monospace",t.textAlign="center",t.fillText(`${this.centDeviation>0?"+":""}${Math.round(this.centDeviation)}¢`,e,35)}t.strokeStyle="#7F8C8D",t.lineWidth=1;for(let r=-50;r<=50;r+=10){const e=i+r*o;t.beginPath(),t.moveTo(e,60),t.lineTo(e,63),t.stroke(),0!==r&&(t.fillStyle="#7F8C8D",t.font="10px sans-serif",t.textAlign="center",t.fillText(`${r}`,e,75))}}renderConfidence(t){const e=this.width-50-10;t.fillStyle="#E0E0E0",t.fillRect(e,10,50,10);const s=50*this.confidence;t.fillStyle=this.confidence>.7?"#32CD32":"#FFA500",t.fillRect(e,10,s,10),t.fillStyle="#7F8C8D",t.font="10px sans-serif",t.textAlign="right",t.fillText("Conf.",e-5,20)}reset(){this.currentFrequency=null,this.centDeviation=0,this.confidence=0}}class N{constructor(t,e,s){this.x=t,this.y=e,this.vx=8*(Math.random()-.5),this.vy=8*(Math.random()-.5)-2,this.life=1,this.decay=.02*Math.random()+.01,this.size=6*Math.random()+2,this.color=s,this.gravity=.2}update(){return this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.life-=this.decay,this.life>0}render(t){t.save(),t.globalAlpha=this.life,t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.size,0,2*Math.PI),t.fill(),t.restore()}}class I{constructor(){this.particles=[],this.maxParticles=50,this.enabled=!0}emitForResult(t,e,s){if(!this.enabled)return;const i={PERFECT:"#FFD700",GREAT:"#32CD32",OK:"#00BFFF",MISS:"#FF4444"}[t]||"#FFFFFF",o=Math.min({PERFECT:30,GREAT:20,OK:10,MISS:5}[t]||0,this.maxParticles);for(let n=0;n<o;n++)this.particles.length<this.maxParticles&&this.particles.push(new N(e,s,i))}emit(t,e,s,i=10){if(this.enabled)for(let o=0;o<Math.min(i,this.maxParticles);o++)this.particles.length<this.maxParticles&&this.particles.push(new N(t,e,s))}update(){this.particles=this.particles.filter(t=>t.update())}render(t){this.enabled&&this.particles.forEach(e=>{e.render(t)})}setEnabled(t){this.enabled=t,t||(this.particles=[])}setMaxParticles(t){this.maxParticles=t,this.particles.length>t&&(this.particles=this.particles.slice(0,t))}clear(){this.particles=[]}getParticleCount(){return this.particles.length}}const P={Tab:"navigate",Enter:"confirm"," ":"pause",Escape:"back",r:"restart",R:"restart",m:"mute",M:"mute",h:"toggleHUD",H:"toggleHUD",1:"octave1",2:"octave2",3:"octave3",4:"octave4",p:"practice",P:"practice","?":"help"};class D{constructor(t,e={}){this.gameEngine=t,this.enabled=!0,this.helpVisible=!1,this.hudVisible=!0,this.callbacks={onHelp:e.onHelp||null,onHUDToggle:e.onHUDToggle||null},this.setupListeners()}setupListeners(){document.addEventListener("keydown",t=>this.handleKeyDown(t))}handleKeyDown(t){if(!this.enabled)return;const e=P[t.key];e&&("Tab"!==t.key&&t.preventDefault(),this.handleAction(e,t))}handleAction(t,e){const s=this.gameEngine?.state||"idle";switch(t){case"pause":"playing"===s?(this.gameEngine.pause(),this.announceToScreenReader("Game paused")):"paused"===s&&(this.gameEngine.resume(),this.announceToScreenReader("Game resumed"));break;case"back":"playing"===s&&(this.gameEngine.pause(),this.announceToScreenReader("Game paused"));break;case"restart":"paused"!==s&&"results"!==s&&"failed"!==s||(this.gameEngine.restart(),this.announceToScreenReader("Restarting game"));break;case"mute":const e=this.gameEngine.toggleMute();this.announceToScreenReader(e?"Audio muted":"Audio unmuted");break;case"toggleHUD":this.hudVisible=!this.hudVisible,this.callbacks.onHUDToggle&&this.callbacks.onHUDToggle(this.hudVisible),this.announceToScreenReader(this.hudVisible?"HUD shown":"HUD hidden");break;case"help":this.helpVisible=!this.helpVisible,this.callbacks.onHelp&&this.callbacks.onHelp(this.helpVisible);break;case"practice":if("idle"===s||"menu"===s){const t=document.getElementById("practice-button");t&&t.click()}break;case"octave1":case"octave2":case"octave3":case"octave4":const i=t.slice(-1);this.handleOctaveSelect(i)}}handleOctaveSelect(t){console.log(`Octave ${t} selected`)}announceToScreenReader(t){const e=document.getElementById("status-announce")||this.createAnnouncer();e.textContent="",setTimeout(()=>{e.textContent=t},100)}createAnnouncer(){const t=document.createElement("div");return t.id="status-announce",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",document.body.appendChild(t),t}enable(){this.enabled=!0}disable(){this.enabled=!1}getHelpText(){return[{key:"Space",action:"Pause/Resume",description:"Toggle game pause"},{key:"Esc",action:"Back",description:"Pause game or go back"},{key:"R",action:"Restart",description:"Restart current challenge"},{key:"M",action:"Mute",description:"Toggle audio mute"},{key:"H",action:"Toggle HUD",description:"Show/hide game overlay"},{key:"P",action:"Practice",description:"Start practice mode"},{key:"1-4",action:"Select Octave",description:"Quick octave selection"},{key:"?",action:"Help",description:"Show/hide this help"},{key:"Tab",action:"Navigate",description:"Move focus to next element"},{key:"Enter",action:"Confirm",description:"Activate focused button"}]}destroy(){document.removeEventListener("keydown",this.handleKeyDown)}}class k{constructor(){this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.loadSettings(),this.setupMediaQueryListeners()}setupMediaQueryListeners(){const t=window.matchMedia("(prefers-reduced-motion: reduce)");t.addEventListener?t.addEventListener("change",t=>{this.prefersReducedMotion=t.matches,this.applySettings()}):t.addListener(t=>{this.prefersReducedMotion=t.matches,this.applySettings()})}loadSettings(){try{const t=JSON.parse(localStorage.getItem("accessibility_settings"));t&&(this.highContrastMode=t.highContrast||!1,this.colorblindMode=t.colorblindMode||"none",this.focusVisible=!1!==t.focusVisible)}catch{}this.applySettings()}saveSettings(){try{localStorage.setItem("accessibility_settings",JSON.stringify({highContrast:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}))}catch(t){console.warn("Failed to save accessibility settings:",t)}this.applySettings()}applySettings(){document.body.classList.toggle("reduced-motion",this.prefersReducedMotion),document.body.classList.toggle("high-contrast",this.highContrastMode),document.body.dataset.colorblindMode=this.colorblindMode,document.body.classList.toggle("focus-visible",this.focusVisible),this.emit("settingsChanged",this.getSettings())}getSettings(){return{prefersReducedMotion:this.prefersReducedMotion,highContrastMode:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}}toggleHighContrast(){return this.highContrastMode=!this.highContrastMode,this.saveSettings(),this.highContrastMode}setColorblindMode(t){["none","deuteranopia","protanopia","tritanopia"].includes(t)?(this.colorblindMode=t,this.saveSettings()):console.warn(`Invalid colorblind mode: ${t}`)}getAdjustedColor(t){if("none"===this.colorblindMode&&!this.highContrastMode)return t;if(this.highContrastMode){return{perfect:"#00FF00",great:"#FFFF00",good:"#FFA500",ok:"#FF6600",miss:"#FF0000"}[t]||t}const e={deuteranopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#FF0066"},protanopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#8800FF"},tritanopia:{perfect:"#FF00FF",great:"#00FFFF",good:"#FF8800",ok:"#FF6600",miss:"#FF0000"}}[this.colorblindMode];return e&&e[t]||t}shouldReduceMotion(){return this.prefersReducedMotion}emit(t,e){const s=new CustomEvent(`accessibility:${t}`,{detail:e});document.dispatchEvent(s)}on(t,e){document.addEventListener(`accessibility:${t}`,t=>{e(t.detail)})}getColorblindModeDescription(){return{none:"Standard colors",deuteranopia:"Red-green colorblindness (Deuteranopia)",protanopia:"Red-blind (Protanopia)",tritanopia:"Blue-yellow colorblindness (Tritanopia)"}[this.colorblindMode]||"Unknown"}reset(){this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.saveSettings()}}class R{constructor(){this.sounds=new Map,this.volume=.7,this.muted=!1,this.loadingPromises=[],this.loadSounds()}async loadSounds(){const t={perfect:"/assets/sounds/perfect.opus",great:"/assets/sounds/great.opus",ok:"/assets/sounds/ok.opus",miss:"/assets/sounds/miss.opus",combo:"/assets/sounds/combo.opus",victory:"/assets/sounds/victory.opus",failure:"/assets/sounds/failure.opus",click:"/assets/sounds/click.opus"},e={perfect:this.createSilentAudio(),great:this.createSilentAudio(),ok:this.createSilentAudio(),miss:this.createSilentAudio(),combo:this.createSilentAudio(),victory:this.createSilentAudio(),failure:this.createSilentAudio(),click:this.createSilentAudio()};for(const[s,i]of Object.entries(t)){const t=this.loadSound(s,i,e[s]);this.loadingPromises.push(t)}return Promise.all(this.loadingPromises)}async loadSound(t,e,s){try{const i=new Audio;return i.volume=this.volume,i.preload="auto",new Promise(o=>{i.addEventListener("canplaythrough",()=>{this.sounds.set(t,i),o()}),i.addEventListener("error",()=>{console.warn(`Failed to load sound: ${t}, using silent fallback`),this.sounds.set(t,s),o()}),i.src=e})}catch(i){console.warn(`Failed to load sound: ${t}`,i),this.sounds.set(t,s)}}createSilentAudio(){const t=new Audio;return t.src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=",t.volume=0,t}play(t,e=1){if(this.muted)return;const s=this.sounds.get(t);if(s)try{const t=s.cloneNode();t.volume=this.volume*e,t.play().catch(t=>{console.debug("Failed to play sound:",t)})}catch(i){console.debug("Error playing sound:",i)}else console.warn(`Sound not found: ${t}`)}playNoteResult(t){const e={PERFECT:"perfect",GREAT:"great",OK:"ok",MISS:"miss"}[t];e&&this.play(e)}playCombo(t){t>0&&t%5==0&&this.play("combo",.8)}playClick(){this.play("click",.5)}playVictory(){this.play("victory",.9)}playFailure(){this.play("failure",.9)}setVolume(t){this.volume=Math.max(0,Math.min(1,t));for(const e of this.sounds.values())e.volume=this.volume}getVolume(){return this.volume}setMuted(t){this.muted=t}toggleMute(){return this.muted=!this.muted,this.muted}isMuted(){return this.muted}stopAll(){for(const t of this.sounds.values())t.pause(),t.currentTime=0}async waitForLoad(){return Promise.all(this.loadingPromises)}}class L{constructor(){this.audioContext=null,this.enabled=!1,this.volume=.3,this.oscillatorType="sine"}initialize(){if(!this.audioContext){const t=window.AudioContext||window.webkitAudioContext;t?this.audioContext=new t:console.warn("Web Audio API not supported")}}playNote(t,e=500){if(this.enabled&&(this.audioContext||this.initialize(),this.audioContext))try{"suspended"===this.audioContext.state&&this.audioContext.resume();const s=this.audioContext.createOscillator(),i=this.audioContext.createGain();s.connect(i),i.connect(this.audioContext.destination),s.frequency.setValueAtTime(t,this.audioContext.currentTime),s.type=this.oscillatorType;const o=this.audioContext.currentTime,n=e/1e3;i.gain.setValueAtTime(0,o),i.gain.linearRampToValueAtTime(this.volume,o+.05),i.gain.setValueAtTime(this.volume,o+n-.1),i.gain.linearRampToValueAtTime(0,o+n),s.start(o),s.stop(o+n),s.addEventListener("ended",()=>{s.disconnect(),i.disconnect()})}catch(s){console.warn("Failed to play reference tone:",s)}}playNoteName(t,e=500){const s=this.noteToFrequency(t);s&&this.playNote(s,e)}async playSequence(t,e=100){if(this.enabled)for(const s of t)s.noteName?this.playNoteName(s.noteName,s.duration||500):s.frequency&&this.playNote(s.frequency,s.duration||500),await this.delay((s.duration||500)+e)}noteToFrequency(t){const e=t.match(/^([A-G])([#b]?)(\d)$/);if(!e)return console.warn(`Invalid note name: ${t}`),null;const[,s,i,o]=e;let n={C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2}[s];return"#"===i&&(n+=1),"b"===i&&(n-=1),n+=12*(parseInt(o)-4),440*Math.pow(2,n/12)}enable(){this.enabled=!0,this.audioContext||this.initialize()}disable(){this.enabled=!1}toggle(){return this.enabled?this.disable():this.enable(),this.enabled}isEnabled(){return this.enabled}setVolume(t){this.volume=Math.max(0,Math.min(1,t))}getVolume(){return this.volume}setOscillatorType(t){["sine","square","sawtooth","triangle"].includes(t)&&(this.oscillatorType=t)}delay(t){return new Promise(e=>setTimeout(e,t))}destroy(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}let H=null,q=null,B=null,O=null,$=null,z=null;const G={loading:document.getElementById("loading-screen"),start:document.getElementById("start-screen"),calibration:document.getElementById("calibration-screen"),game:document.getElementById("game-screen"),results:document.getElementById("results-screen"),error:document.getElementById("error-screen")};function V(t){Object.values(G).forEach(t=>t.classList.remove("active")),G[t]&&G[t].classList.add("active"),"game"===t&&q?q.start():q&&q.stop()}function _(t){document.getElementById("error-message").textContent=t,V("error")}async function U(){try{V("calibration");if(!(await H.startCalibration(t=>{document.getElementById("calibration-instruction").textContent=`Calibrating... ${Math.round(100*t)}%`})).success)throw new Error("Calibration failed");V("game"),H.startChallenge(4,"normal"),H.on("pitch-update",t=>{q&&q.updateGameState({pitchData:t,targetNote:t.targetNote,holdProgress:t.holdProgress})}),H.on("note-hit",t=>{q&&q.updateGameState({noteResult:t.score.tier,score:t.score.totalPoints,combo:t.score.combo}),$&&($.playNoteResult(t.score.tier),$.playCombo(t.score.combo));const e=document.getElementById("score-value");e&&(e.textContent=t.score.totalPoints);const s=document.getElementById("combo-value");s&&(s.textContent=t.score.combo)}),H.on("note-miss",()=>{q&&q.updateGameState({noteResult:"MISS"}),$&&$.playNoteResult("MISS")}),H.on("challenge-complete",t=>{V("results"),function(t){document.getElementById("final-grade").textContent=t.grade,document.getElementById("final-score").textContent=t.finalScore,document.getElementById("stats-display").innerHTML=`\n    <div>Perfect: ${t.statistics.perfectCount}</div>\n    <div>Great: ${t.statistics.greatCount}</div>\n    <div>OK: ${t.statistics.okCount}</div>\n    <div>Miss: ${t.statistics.missCount}</div>\n    <div>Max Combo: ${t.statistics.maxCombo}</div>\n    <div>Accuracy: ${t.statistics.accuracy}%</div>\n  `}(t),$&&$.playVictory(),function(t){const e=document.getElementById("status-announce");e&&(e.textContent="",setTimeout(()=>{e.textContent=t},100))}(`Challenge complete! Grade: ${t.grade}`)}),H.on("challenge-failed",t=>{_(`Challenge failed: ${t.reason}`),$&&$.playFailure()})}catch(t){console.error("Failed to start challenge:",t),_(`Failed to start: ${t.message}`)}}function W(){const t=document.getElementById("help-overlay");if(t){t.hasAttribute("hidden")?(t.removeAttribute("hidden"),t.focus()):t.setAttribute("hidden","")}}function Q(t){const e=document.getElementById("hud");e&&(e.style.display=t?"flex":"none")}document.getElementById("start-button")?.addEventListener("click",()=>{$&&$.playClick(),U()}),document.getElementById("practice-button")?.addEventListener("click",()=>{$&&$.playClick(),console.log("Practice mode not yet implemented")}),document.getElementById("settings-button")?.addEventListener("click",()=>{$&&$.playClick(),console.log("Settings not yet implemented")}),document.getElementById("play-again-button")?.addEventListener("click",()=>{$&&$.playClick(),U()}),document.getElementById("menu-button")?.addEventListener("click",()=>{$&&$.playClick(),V("start")}),document.getElementById("error-menu-button")?.addEventListener("click",()=>{$&&$.playClick(),V("start")}),document.getElementById("retry-button")?.addEventListener("click",()=>{$&&$.playClick(),V("start")}),document.getElementById("pause-button")?.addEventListener("click",()=>{$&&$.playClick(),H&&H.pause()}),document.getElementById("close-help")?.addEventListener("click",()=>{$&&$.playClick(),W()}),async function(){try{console.log("Initializing Scale Climber...");if(!(window.AudioContext||window.webkitAudioContext))throw new Error("Web Audio API not supported in this browser");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Microphone access not supported in this browser");O=new k,console.log("Accessibility settings initialized"),$=new R,await $.waitForLoad(),console.log("Audio feedback initialized"),z=new L,console.log("Reference tone generator initialized"),H=new T;const t=await H.initialize();if(!t.success)throw new Error(t.error||"Failed to initialize game engine");H.toggleMute=()=>$.toggleMute(),H.restart=()=>{V("start")};const e=document.getElementById("game-canvas");q=new A(e);const s=new F,i=new E,o=new I;q.setComponents({character:s,pitchMeter:i,particleSystem:o}),B=new D(H,{onHelp:W,onHUDToggle:Q}),console.log("Keyboard controls initialized"),console.log("Scale Climber initialized successfully"),setTimeout(()=>{V("start")},500)}catch(t){console.error("Failed to initialize app:",t),_(`Failed to initialize: ${t.message}`)}}();
