import{g as e}from"./game-logic-VRbJBiwh.js";class t{constructor(){if(t.instance)return t.instance;this.context=null,this.stream=null,this.analyser=null,this.source=null,this.gainNode=null,this.isInitialized=!1,this.listeners=new Map,this.deviceChangeListener=null,t.instance=this}async initialize(){try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return{success:!1,error:"WEB_AUDIO_UNSUPPORTED"};this.context=new e,"suspended"===this.context.state&&console.warn("AudioContext suspended. Waiting for user gesture to resume.");const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:{ideal:44100},channelCount:1}});return this.stream=t,this.source=this.context.createMediaStreamSource(t),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=0,this.gainNode=this.context.createGain(),this.gainNode.gain.value=1,this.source.connect(this.gainNode),this.gainNode.connect(this.analyser),this.setupDeviceChangeMonitoring(),this.isInitialized=!0,{success:!0,sampleRate:this.context.sampleRate}}catch(e){return{success:!1,error:this.categorizeError(e)}}}async resume(){if(!this.context)return!1;if("suspended"===this.context.state)try{return await this.context.resume(),"running"===this.context.state}catch(e){return console.error("Failed to resume AudioContext:",e),!1}return"running"===this.context.state}getAudioData(){if(!this.analyser||!this.isInitialized)return new Float32Array(0);const e=this.analyser.fftSize,t=new Float32Array(e);return this.analyser.getFloatTimeDomainData(t),t}getVolumeLevel(){const e=this.getAudioData();if(0===e.length)return 0;let t=0;for(let i=0;i<e.length;i++)t+=e[i]*e[i];const s=Math.sqrt(t/e.length);return Math.min(10*s,1)}setupDeviceChangeMonitoring(){if(!this.stream)return;this.stream.getTracks().forEach(e=>{e.addEventListener("ended",()=>{this.emit("device-disconnected",{deviceId:e.id})})}),this.deviceChangeListener=()=>{this.emit("device-changed")},navigator.mediaDevices.addEventListener("devicechange",this.deviceChangeListener)}categorizeError(e){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?"PERMISSION_DENIED":"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?"NO_MICROPHONE":"NotReadableError"===e.name||"TrackStartError"===e.name?"DEVICE_IN_USE":"OverconstrainedError"===e.name?"CONSTRAINTS_NOT_SATISFIED":"TypeError"===e.name?"TYPE_ERROR":"UNKNOWN_ERROR":"NO_MEDIA_DEVICES"}getState(){return this.context?this.context.state:"not-initialized"}getSampleRate(){return this.context?this.context.sampleRate:0}async playReferenceTone(e,t=1){if(!this.context)throw new Error("AudioContext not initialized");await this.resume();const s=this.context.createOscillator(),i=this.context.createGain();s.type="sine",s.frequency.value=e;const n=this.context.currentTime;return i.gain.setValueAtTime(0,n),i.gain.linearRampToValueAtTime(.3,n+.01),i.gain.linearRampToValueAtTime(.3,n+t-.01),i.gain.linearRampToValueAtTime(0,n+t),s.connect(i),i.connect(this.context.destination),s.start(n),s.stop(n+t),new Promise(e=>{s.onended=e})}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const s=this.listeners.get(e),i=s.indexOf(t);i>-1&&s.splice(i,1)}emit(e,t){if(!this.listeners.has(e))return;this.listeners.get(e).forEach(s=>{try{s(t)}catch(i){console.error(`Error in event listener for ${e}:`,i)}})}async destroy(){this.deviceChangeListener&&(navigator.mediaDevices.removeEventListener("devicechange",this.deviceChangeListener),this.deviceChangeListener=null),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.source&&(this.source.disconnect(),this.source=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.analyser&&(this.analyser=null),this.context&&"closed"!==this.context.state&&(await this.context.close(),this.context=null),this.isInitialized=!1,this.listeners.clear(),t.instance=null}static getInstance(){return t.instance?t.instance:new t}}class s{constructor(e){this.audioContextManager=e,this.worker=null,this.isInitialized=!1,this.messageId=0,this.pendingRequests=new Map,this.lastResult=null}async init(){return new Promise((e,t)=>{try{this.worker=new Worker(new URL("/scale-climber/assets/PitchDetector.worker-BSdwUMKd.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("PitchDetector Worker Error:",e)};const s=this.audioContextManager.getSampleRate();this.worker.postMessage({type:"init",data:{sampleRate:s,bufferSize:1024,yinThreshold:.15}});const i=t=>{"initialized"===t.data.type&&(this.isInitialized=!0,this.worker.removeEventListener("message",i),e())};this.worker.addEventListener("message",i),setTimeout(()=>{this.isInitialized||t(new Error("Worker initialization timeout"))},5e3)}catch(s){t(s)}})}handleWorkerMessage(t){const{type:s,id:i,data:n}=t;switch(s){case"result":if(this.pendingRequests.has(i)){const{resolve:t}=this.pendingRequests.get(i);this.pendingRequests.delete(i);let s=n;if(n.frequency){const t=e(n.frequency);s={...n,...t}}else s={...n,note:null,cents:0,targetFrequency:0,midi:0};this.lastResult=s,t(s)}break;case"initialized":case"config-updated":break;default:console.warn(`Unknown worker message type: ${s}`)}}async detect(){if(!this.isInitialized)throw new Error("PitchDetector not initialized. Call init() first.");return new Promise((e,t)=>{try{const s=this.audioContextManager.getAudioData();if(0===s.length)return void e({frequency:null,note:null,cents:0,confidence:0,clarity:0,volume:0,targetFrequency:0,midi:0});const i=this.messageId++;this.pendingRequests.set(i,{resolve:e,reject:t});const n=new Float32Array(s);this.worker.postMessage({type:"process",id:i,data:{buffer:n}},[n.buffer]),setTimeout(()=>{this.pendingRequests.has(i)&&(this.pendingRequests.delete(i),t(new Error("Pitch detection timeout")))},1e3)}catch(s){t(s)}})}getLastResult(){return this.lastResult}updateConfig(e){this.worker&&this.worker.postMessage({type:"update-config",data:e})}isReady(){return this.isInitialized&&null!==this.worker}destroy(){this.worker&&(this.worker.terminate(),this.worker=null),this.pendingRequests.clear(),this.isInitialized=!1,this.lastResult=null}}class i{constructor(e){this.pitchDetector=e,this.state="idle",this.volumeSamples=[],this.pitchSamples=[],this.result=null,this.onProgressCallback=null}async start(e){this.reset(),this.onProgressCallback=e;try{this.state="volume_test",this.reportProgress(0,"Testing microphone volume..."),await this.runVolumeTest(3e3);return this.volumeSamples.reduce((e,t)=>e+t,0)/this.volumeSamples.length<.05?{success:!1,error:"VOLUME_TOO_LOW",message:"Microphone not detecting sound. Please speak or sing louder."}:(this.state="range_detect",this.reportProgress(.3,"Detecting vocal range... Sing from low to high notes"),await this.runRangeDetection(1e4),this.pitchSamples.length<10?{success:!1,error:"INSUFFICIENT_DATA",message:"Not enough pitch data. Please sing more notes."}:(this.state="analysis",this.reportProgress(.9,"Analyzing results..."),this.result=this.analyzeResults(),this.state="complete",this.reportProgress(1,"Calibration complete!"),{success:!0,...this.result}))}catch(t){return console.error("Calibration error:",t),{success:!1,error:"CALIBRATION_FAILED",message:t.message}}}async runVolumeTest(e){const t=Date.now();for(;Date.now()-t<e;){const s=await this.pitchDetector.detect();this.volumeSamples.push(s.volume);const i=(Date.now()-t)/e;this.reportProgress(.3*i,"Testing microphone volume..."),await this.sleep(100)}}async runRangeDetection(e){const t=Date.now();for(;Date.now()-t<e;){const s=await this.pitchDetector.detect();s.frequency&&s.confidence>.7&&s.volume>.1&&this.pitchSamples.push({frequency:s.frequency,note:s.note,midi:s.midi,confidence:s.confidence});const i=.3+(Date.now()-t)/e*.6,n=Math.ceil((e-(Date.now()-t))/1e3);this.reportProgress(i,`Sing from low to high... (${n}s remaining)`),await this.sleep(200)}}analyzeResults(){const e=this.pitchSamples.map(e=>e.midi),t=Math.min(...e),s=Math.max(...e),i=this.pitchSamples.find(e=>e.midi===t),n=this.pitchSamples.find(e=>e.midi===s),r=(t+s)/2;let a,o;return r<50?(a="Bass",o=3):r<57?(a="Baritone",o=3):r<64?(a="Tenor",o=4):r<72?(a="Alto",o=4):(a="Soprano",o=4),{lowestNote:i.note,highestNote:n.note,lowestMidi:t,highestMidi:s,recommendedOctave:o,voiceType:a}}reportProgress(e,t){this.onProgressCallback&&this.onProgressCallback(this.state,e,t)}sleep(e){return new Promise(t=>setTimeout(t,e))}reset(){this.state="idle",this.volumeSamples=[],this.pitchSamples=[],this.result=null}getState(){return this.state}getResult(){return this.result}}export{t as A,i as C,s as P};
