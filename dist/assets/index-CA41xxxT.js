import{G as e}from"./game-logic-DIPB9U6A.js";import{C as t,a as o,P as n,b as i}from"./visuals-DAVB2UIO.js";import"./audio-D-pHvAC-.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const s={Tab:"navigate",Enter:"confirm"," ":"pause",Escape:"back",r:"restart",R:"restart",m:"mute",M:"mute",h:"toggleHUD",H:"toggleHUD",1:"octave1",2:"octave2",3:"octave3",4:"octave4",p:"practice",P:"practice","?":"help"};class a{constructor(e,t={}){this.gameEngine=e,this.enabled=!0,this.helpVisible=!1,this.hudVisible=!0,this.callbacks={onHelp:t.onHelp||null,onHUDToggle:t.onHUDToggle||null},this.setupListeners()}setupListeners(){document.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){if(!this.enabled)return;const t=s[e.key];t&&("Tab"!==e.key&&e.preventDefault(),this.handleAction(t,e))}handleAction(e){const t=this.gameEngine?.state||"idle";switch(e){case"pause":"playing"===t?(this.gameEngine.pause(),this.announceToScreenReader("Game paused")):"paused"===t&&(this.gameEngine.resume(),this.announceToScreenReader("Game resumed"));break;case"back":"playing"===t&&(this.gameEngine.pause(),this.announceToScreenReader("Game paused"));break;case"restart":"paused"!==t&&"results"!==t&&"failed"!==t||(this.gameEngine.restart(),this.announceToScreenReader("Restarting game"));break;case"mute":{const e=this.gameEngine.toggleMute();this.announceToScreenReader(e?"Audio muted":"Audio unmuted");break}case"toggleHUD":this.hudVisible=!this.hudVisible,this.callbacks.onHUDToggle&&this.callbacks.onHUDToggle(this.hudVisible),this.announceToScreenReader(this.hudVisible?"HUD shown":"HUD hidden");break;case"help":this.helpVisible=!this.helpVisible,this.callbacks.onHelp&&this.callbacks.onHelp(this.helpVisible);break;case"practice":if("idle"===t||"menu"===t){const e=document.getElementById("practice-button");e&&e.click()}break;case"octave1":case"octave2":case"octave3":case"octave4":{const t=e.slice(-1);this.handleOctaveSelect(t);break}}}handleOctaveSelect(e){console.log(`Octave ${e} selected`)}announceToScreenReader(e){const t=document.getElementById("status-announce")||this.createAnnouncer();t.textContent="",setTimeout(()=>{t.textContent=e},100)}createAnnouncer(){const e=document.createElement("div");return e.id="status-announce",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",document.body.appendChild(e),e}enable(){this.enabled=!0}disable(){this.enabled=!1}getHelpText(){return[{key:"Space",action:"Pause/Resume",description:"Toggle game pause"},{key:"Esc",action:"Back",description:"Pause game or go back"},{key:"R",action:"Restart",description:"Restart current challenge"},{key:"M",action:"Mute",description:"Toggle audio mute"},{key:"H",action:"Toggle HUD",description:"Show/hide game overlay"},{key:"P",action:"Practice",description:"Start practice mode"},{key:"1-4",action:"Select Octave",description:"Quick octave selection"},{key:"?",action:"Help",description:"Show/hide this help"},{key:"Tab",action:"Navigate",description:"Move focus to next element"},{key:"Enter",action:"Confirm",description:"Activate focused button"}]}destroy(){document.removeEventListener("keydown",this.handleKeyDown)}}class r{constructor(){this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.loadSettings(),this.setupMediaQueryListeners()}setupMediaQueryListeners(){const e=window.matchMedia("(prefers-reduced-motion: reduce)");e.addEventListener?e.addEventListener("change",e=>{this.prefersReducedMotion=e.matches,this.applySettings()}):e.addListener(e=>{this.prefersReducedMotion=e.matches,this.applySettings()})}loadSettings(){try{const e=JSON.parse(localStorage.getItem("accessibility_settings"));e&&(this.highContrastMode=e.highContrast||!1,this.colorblindMode=e.colorblindMode||"none",this.focusVisible=!1!==e.focusVisible)}catch{}this.applySettings()}saveSettings(){try{localStorage.setItem("accessibility_settings",JSON.stringify({highContrast:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}))}catch(e){console.warn("Failed to save accessibility settings:",e)}this.applySettings()}applySettings(){document.body.classList.toggle("reduced-motion",this.prefersReducedMotion),document.body.classList.toggle("high-contrast",this.highContrastMode),document.body.dataset.colorblindMode=this.colorblindMode,document.body.classList.toggle("focus-visible",this.focusVisible),this.emit("settingsChanged",this.getSettings())}getSettings(){return{prefersReducedMotion:this.prefersReducedMotion,highContrastMode:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}}toggleHighContrast(){return this.highContrastMode=!this.highContrastMode,this.saveSettings(),this.highContrastMode}setColorblindMode(e){["none","deuteranopia","protanopia","tritanopia"].includes(e)?(this.colorblindMode=e,this.saveSettings()):console.warn(`Invalid colorblind mode: ${e}`)}getAdjustedColor(e){if("none"===this.colorblindMode&&!this.highContrastMode)return e;if(this.highContrastMode){return{perfect:"#00FF00",great:"#FFFF00",good:"#FFA500",ok:"#FF6600",miss:"#FF0000"}[e]||e}const t={deuteranopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#FF0066"},protanopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#8800FF"},tritanopia:{perfect:"#FF00FF",great:"#00FFFF",good:"#FF8800",ok:"#FF6600",miss:"#FF0000"}}[this.colorblindMode];return t&&t[e]||e}shouldReduceMotion(){return this.prefersReducedMotion}emit(e,t){const o=new CustomEvent(`accessibility:${e}`,{detail:t});document.dispatchEvent(o)}on(e,t){document.addEventListener(`accessibility:${e}`,e=>{t(e.detail)})}getColorblindModeDescription(){return{none:"Standard colors",deuteranopia:"Red-green colorblindness (Deuteranopia)",protanopia:"Red-blind (Protanopia)",tritanopia:"Blue-yellow colorblindness (Tritanopia)"}[this.colorblindMode]||"Unknown"}reset(){this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.saveSettings()}}class c{constructor(){this.sounds=new Map,this.volume=.7,this.muted=!1,this.loadingPromises=[],this.loadSounds()}async loadSounds(){const e="/scale-climber/",t={perfect:`${e}assets/sounds/perfect.opus`,great:`${e}assets/sounds/great.opus`,ok:`${e}assets/sounds/ok.opus`,miss:`${e}assets/sounds/miss.opus`,combo:`${e}assets/sounds/combo.opus`,victory:`${e}assets/sounds/victory.opus`,failure:`${e}assets/sounds/failure.opus`,click:`${e}assets/sounds/click.opus`},o={perfect:this.createSilentAudio(),great:this.createSilentAudio(),ok:this.createSilentAudio(),miss:this.createSilentAudio(),combo:this.createSilentAudio(),victory:this.createSilentAudio(),failure:this.createSilentAudio(),click:this.createSilentAudio()};for(const[n,i]of Object.entries(t)){const e=this.loadSound(n,i,o[n]);this.loadingPromises.push(e)}return Promise.all(this.loadingPromises)}async loadSound(e,t,o){try{const n=new Audio;return n.volume=this.volume,n.preload="auto",new Promise(i=>{n.addEventListener("canplaythrough",()=>{this.sounds.set(e,n),i()}),n.addEventListener("error",()=>{console.warn(`Failed to load sound: ${e}, using silent fallback`),this.sounds.set(e,o),i()}),n.src=t})}catch(n){return console.warn(`Failed to load sound: ${e}`,n),this.sounds.set(e,o),Promise.resolve()}}createSilentAudio(){const e=new Audio;return e.src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=",e.volume=0,e}play(e,t=1){if(this.muted)return;const o=this.sounds.get(e);if(o)try{const e=o.cloneNode();e.volume=this.volume*t,e.play().catch(e=>{console.debug("Failed to play sound:",e)})}catch(n){console.debug("Error playing sound:",n)}else console.warn(`Sound not found: ${e}`)}playNoteResult(e){const t={PERFECT:"perfect",GREAT:"great",OK:"ok",MISS:"miss"}[e];t&&this.play(t)}playCombo(e){e>0&&e%5==0&&this.play("combo",.8)}playClick(){this.play("click",.5)}playVictory(){this.play("victory",.9)}playFailure(){this.play("failure",.9)}setVolume(e){this.volume=Math.max(0,Math.min(1,e));for(const t of this.sounds.values())t.volume=this.volume}getVolume(){return this.volume}setMuted(e){this.muted=e}toggleMute(){return this.muted=!this.muted,this.muted}isMuted(){return this.muted}stopAll(){for(const e of this.sounds.values())e.pause(),e.currentTime=0}async waitForLoad(){return Promise.all(this.loadingPromises)}}class l{constructor(){this.audioContext=null,this.enabled=!1,this.volume=.3,this.oscillatorType="sine"}initialize(){if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;e?this.audioContext=new e:console.warn("Web Audio API not supported")}}playNote(e,t=500){if(this.enabled&&(this.audioContext||this.initialize(),this.audioContext))try{"suspended"===this.audioContext.state&&this.audioContext.resume();const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();o.connect(n),n.connect(this.audioContext.destination),o.frequency.setValueAtTime(e,this.audioContext.currentTime),o.type=this.oscillatorType;const i=this.audioContext.currentTime,s=t/1e3;n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(this.volume,i+.05),n.gain.setValueAtTime(this.volume,i+s-.1),n.gain.linearRampToValueAtTime(0,i+s),o.start(i),o.stop(i+s),o.addEventListener("ended",()=>{o.disconnect(),n.disconnect()})}catch(o){console.warn("Failed to play reference tone:",o)}}playNoteName(e,t=500){const o=this.noteToFrequency(e);o&&this.playNote(o,t)}async playSequence(e,t=100){if(this.enabled)for(const o of e)o.noteName?this.playNoteName(o.noteName,o.duration||500):o.frequency&&this.playNote(o.frequency,o.duration||500),await this.delay((o.duration||500)+t)}noteToFrequency(e){const t=e.match(/^([A-G])([#b]?)(\d)$/);if(!t)return console.warn(`Invalid note name: ${e}`),null;const[,o,n,i]=t;let s={C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2}[o];return"#"===n&&(s+=1),"b"===n&&(s-=1),s+=12*(parseInt(i,10)-4),440*2**(s/12)}enable(){this.enabled=!0,this.audioContext||this.initialize()}disable(){this.enabled=!1}toggle(){return this.enabled?this.disable():this.enable(),this.enabled}isEnabled(){return this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}getVolume(){return this.volume}setOscillatorType(e){["sine","square","sawtooth","triangle"].includes(e)&&(this.oscillatorType=e)}delay(e){return new Promise(t=>setTimeout(t,e))}destroy(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}let d=null,u=null,h=null;const m={loading:document.getElementById("loading-screen"),start:document.getElementById("start-screen"),"calibration-ready":document.getElementById("calibration-ready-screen"),calibration:document.getElementById("calibration-screen"),game:document.getElementById("game-screen"),results:document.getElementById("results-screen"),error:document.getElementById("error-screen")};function g(e){Object.values(m).forEach(e=>e.classList.remove("active")),m[e]&&m[e].classList.add("active"),"game"===e&&u?u.start():u&&u.stop()}function p(e){document.getElementById("error-message").textContent=e,g("error")}async function y(){try{g("calibration"),d.audioManager&&await d.audioManager.resume();const e=document.getElementById("calibration-instruction");e.textContent="Get ready... 3",await b(1e3),e.textContent="Get ready... 2",await b(1e3),e.textContent="Get ready... 1",await b(1e3),e.textContent="START SINGING! ðŸŽ¤",await b(500);const t=await d.startCalibration((t,o,n)=>{const i=d.pitchDetector.getLastResult(),s=i?.note?`â™ª ${i.note}`:"â™ª ...",a=i?.volume?Math.round(100*i.volume):0;e.textContent=`${n} | ${s} | Vol: ${a}%`});if(!t.success)throw new Error(t.message||"Calibration failed");g("game"),d.startChallenge(4,"normal"),d.on("pitch-update",e=>{u&&u.updateGameState({pitchData:e,targetNote:e.targetNote,holdProgress:e.holdProgress})}),d.on("note-hit",e=>{u&&u.updateGameState({noteResult:e.score.tier,score:e.score.totalPoints,combo:e.score.combo}),h&&(h.playNoteResult(e.score.tier),h.playCombo(e.score.combo));const t=document.getElementById("score-value");t&&(t.textContent=e.score.totalPoints);const o=document.getElementById("combo-value");o&&(o.textContent=e.score.combo)}),d.on("note-miss",()=>{u&&u.updateGameState({noteResult:"MISS"}),h&&h.playNoteResult("MISS")}),d.on("challenge-complete",e=>{g("results"),function(e){document.getElementById("final-grade").textContent=e.grade,document.getElementById("final-score").textContent=e.finalScore,document.getElementById("stats-display").innerHTML=`\n    <div>Perfect: ${e.statistics.perfectCount}</div>\n    <div>Great: ${e.statistics.greatCount}</div>\n    <div>OK: ${e.statistics.okCount}</div>\n    <div>Miss: ${e.statistics.missCount}</div>\n    <div>Max Combo: ${e.statistics.maxCombo}</div>\n    <div>Accuracy: ${e.statistics.accuracy}%</div>\n  `}(e),h&&h.playVictory(),function(e){const t=document.getElementById("status-announce");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},100))}(`Challenge complete! Grade: ${e.grade}`)}),d.on("challenge-failed",e=>{p(`Challenge failed: ${e.reason}`),h&&h.playFailure()})}catch(e){console.error("Failed to start challenge:",e),p(`Failed to start: ${e.message}`)}}function b(e){return new Promise(t=>setTimeout(t,e))}function v(){const e=document.getElementById("help-overlay");if(e){e.hasAttribute("hidden")?(e.removeAttribute("hidden"),e.focus()):e.setAttribute("hidden","")}}function f(e){const t=document.getElementById("hud");t&&(t.style.display=e?"flex":"none")}document.getElementById("start-button")?.addEventListener("click",()=>{h&&h.playClick(),g("calibration-ready")}),document.getElementById("begin-calibration-button")?.addEventListener("click",()=>{h&&h.playClick(),y()}),document.getElementById("cancel-calibration-button")?.addEventListener("click",()=>{h&&h.playClick(),g("start")}),document.getElementById("practice-button")?.addEventListener("click",()=>{h&&h.playClick(),console.log("Practice mode not yet implemented")}),document.getElementById("settings-button")?.addEventListener("click",()=>{h&&h.playClick(),console.log("Settings not yet implemented")}),document.getElementById("play-again-button")?.addEventListener("click",()=>{h&&h.playClick(),startChallenge()}),document.getElementById("menu-button")?.addEventListener("click",()=>{h&&h.playClick(),g("start")}),document.getElementById("error-menu-button")?.addEventListener("click",()=>{h&&h.playClick(),g("start")}),document.getElementById("retry-button")?.addEventListener("click",()=>{h&&h.playClick(),g("start")}),document.getElementById("pause-button")?.addEventListener("click",()=>{h&&h.playClick(),d&&d.pause()}),document.getElementById("close-help")?.addEventListener("click",()=>{h&&h.playClick(),v()}),async function(){try{console.log("Initializing Scale Climber...");if(!(window.AudioContext||window.webkitAudioContext))throw new Error("Web Audio API not supported in this browser");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Microphone access not supported in this browser");new r,console.log("Accessibility settings initialized"),h=new c,await h.waitForLoad(),console.log("Audio feedback initialized"),new l,console.log("Reference tone generator initialized"),d=new e;const s=await d.initialize();if(!s.success)throw new Error(s.error||"Failed to initialize game engine");d.toggleMute=()=>h.toggleMute(),d.restart=()=>{g("start")};const m=document.getElementById("game-canvas");u=new t(m);const p=new o,y=new n,b=new i;u.setComponents({character:p,pitchMeter:y,particleSystem:b}),new a(d,{onHelp:v,onHUDToggle:f}),console.log("Keyboard controls initialized"),console.log("Scale Climber initialized successfully"),setTimeout(()=>{g("start")},500)}catch(s){console.error("Failed to initialize app:",s),p(`Failed to initialize: ${s.message}`)}}(),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/scale-climber/sw.js").then(e=>{console.log("Service Worker registered:",e.scope),setInterval(()=>{e.update()},36e5),e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&function(){const e=document.createElement("div");e.id="update-banner",e.className="update-banner",e.setAttribute("role","alert"),e.setAttribute("aria-live","assertive"),e.innerHTML='\n    <div class="update-banner-content">\n      <p>ðŸŽµ A new version is available!</p>\n      <button id="update-btn" class="primary-button">Update Now</button>\n      <button id="dismiss-update" class="text-button">Later</button>\n    </div>\n  ',document.body.appendChild(e),document.getElementById("update-btn")?.addEventListener("click",()=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SKIP_WAITING"})}),document.getElementById("dismiss-update")?.addEventListener("click",()=>{e.remove()})}()})})}).catch(e=>{console.error("Service Worker registration failed:",e)});let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())})});
