import{A as t,P as e,C as s}from"./audio-BzDFhBRO.js";const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function o(t){return t<=0?0:12*Math.log2(t/440)+69}function r(t){return 440*2**((t-69)/12)}function n(t){if(t<=0)return{note:null,frequency:0,targetFrequency:0,cents:0,midi:0};const e=o(t),s=Math.round(e),n=100*(e-s),a=r(s);return{note:function(t){const e=Math.round(t),s=Math.floor(e/12)-1;return`${i[e%12]}${s}`}(s),frequency:t,targetFrequency:a,cents:Math.round(10*n)/10,midi:s}}function a(t,e,s=25){const n=function(t){const e=t.match(/^([A-G]#?)(-?\d+)$/);if(!e)throw new Error(`Invalid note name: ${t}`);const s=e[1],o=parseInt(e[2],10),r=i.indexOf(s);if(-1===r)throw new Error(`Invalid note: ${s}`);return 12*(o+1)+r}(e),a=r(n),h=100*(o(t)-n);return{match:Math.abs(h)<=s,cents:Math.round(10*h)/10,targetFrequency:a}}const h={easy:{tolerance:50,holdTime:1200,maxAttempts:5},normal:{tolerance:25,holdTime:1500,maxAttempts:3},hard:{tolerance:10,holdTime:1800,maxAttempts:3}};class c{constructor(t){var e;this.config={octave:t.octave||4,difficulty:t.difficulty||"normal",onNoteHit:t.onNoteHit||(()=>{}),onNoteMiss:t.onNoteMiss||(()=>{}),onComplete:t.onComplete||(()=>{}),onFail:t.onFail||(()=>{}),onProgress:t.onProgress||(()=>{})},this.scale=[`C${e=this.config.octave}`,`D${e}`,`E${e}`,`F${e}`,`G${e}`,`A${e}`,`B${e}`,`C${e+1}`],this.difficultySettings=h[this.config.difficulty],this.currentNoteIndex=0,this.currentNoteAttempts=0,this.totalAttempts=0,this.startTime=null,this.noteStartTime=null,this.holdStartTime=null,this.holdSamples=[],this.isHolding=!1,this.failureCount=0,this.state="ready"}start(){this.startTime=Date.now(),this.noteStartTime=Date.now(),this.state="active",this.emitProgress()}update(t){if("active"!==this.state)return{stateChanged:!1};if(Date.now()-this.startTime>12e4)return this.fail("TIME_LIMIT_EXCEEDED"),{stateChanged:!0,newState:"failed"};const e=this.scale[this.currentNoteIndex];if(t.frequency&&t.confidence>.7){const s=a(t.frequency,e,this.difficultySettings.tolerance);return s.match?this.handleNoteMatch(t,s):this.handleNoteOff()}return this.handleNoteOff()}handleNoteMatch(t,e){this.isHolding||(this.isHolding=!0,this.holdStartTime=Date.now(),this.holdSamples=[]),this.holdSamples.push({cents:e.cents,confidence:t.confidence,timestamp:Date.now()});return Date.now()-this.holdStartTime>=this.difficultySettings.holdTime?this.completeNote():{stateChanged:!1}}handleNoteOff(){return this.isHolding&&(this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[]),{stateChanged:!1}}completeNote(){const t=this.holdSamples.length>0?this.holdSamples.reduce((t,e)=>t+e.cents,0)/this.holdSamples.length:0,e=Date.now()-this.noteStartTime;return this.config.onNoteHit({noteIndex:this.currentNoteIndex,note:this.scale[this.currentNoteIndex],averageCents:t,timeToHit:e,holdDuration:this.holdSamples.length>0?this.holdSamples[this.holdSamples.length-1].timestamp-this.holdSamples[0].timestamp:0,attempts:this.currentNoteAttempts+1}),this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.currentNoteIndex++,this.currentNoteAttempts=0,this.noteStartTime=Date.now(),this.currentNoteIndex>=this.scale.length?(this.state="complete",this.config.onComplete(),{stateChanged:!0,newState:"complete",noteCompleted:!0}):(this.emitProgress(),{stateChanged:!1,noteCompleted:!0})}recordFailedAttempt(){this.currentNoteAttempts++,this.totalAttempts++,this.currentNoteAttempts>=this.difficultySettings.maxAttempts&&(this.failureCount++,this.config.onNoteMiss({noteIndex:this.currentNoteIndex,note:this.scale[this.currentNoteIndex],attempts:this.currentNoteAttempts}),this.failureCount>=3?this.fail("TOO_MANY_FAILURES"):(this.currentNoteIndex++,this.currentNoteAttempts=0,this.noteStartTime=Date.now(),this.currentNoteIndex>=this.scale.length?(this.state="complete",this.config.onComplete()):this.emitProgress()))}fail(t){this.state="failed",this.config.onFail(t)}emitProgress(){this.config.onProgress({currentNoteIndex:this.currentNoteIndex,totalNotes:this.scale.length,currentNote:this.scale[this.currentNoteIndex],progress:this.currentNoteIndex/this.scale.length})}getState(){return this.state}getCurrentNote(){return this.currentNoteIndex>=this.scale.length?null:this.scale[this.currentNoteIndex]}getHoldProgress(){if(!this.isHolding||!this.holdStartTime)return 0;const t=Date.now()-this.holdStartTime;return Math.min(t/this.difficultySettings.holdTime,1)}getStateForPersistence(){return{currentNoteIndex:this.currentNoteIndex,currentNoteAttempts:this.currentNoteAttempts,totalAttempts:this.totalAttempts,failureCount:this.failureCount,startTime:this.startTime,noteStartTime:this.noteStartTime,state:this.state}}restore(t){this.currentNoteIndex=t.currentNoteIndex||0,this.currentNoteAttempts=t.currentNoteAttempts||0,this.totalAttempts=t.totalAttempts||0,this.failureCount=t.failureCount||0,this.startTime=t.startTime||Date.now(),this.noteStartTime=t.noteStartTime||Date.now(),this.state=t.state||"ready"}getStatistics(){return{notesCompleted:this.currentNoteIndex,totalNotes:this.scale.length,totalAttempts:this.totalAttempts,failureCount:this.failureCount,timeElapsed:this.startTime?Date.now()-this.startTime:0,difficulty:this.config.difficulty,octave:this.config.octave}}}class l{constructor(t){this.config={targetNote:t.targetNote||"C4",tolerance:t.tolerance||25,holdTime:t.holdTime||1500,onNoteHit:t.onNoteHit||(()=>{}),onProgress:t.onProgress||(()=>{})},this.type="practice",this.attempts=0,this.successfulHits=0,this.totalHoldTime=0,this.bestAccuracy=null,this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.statistics={attempts:0,hits:0,totalCents:0,bestCents:null}}start(){}update(t){if(t.frequency&&t.confidence>.7){const e=a(t.frequency,this.config.targetNote,this.config.tolerance);return e.match?this.handleNoteMatch(t,e):this.handleNoteOff()}return this.handleNoteOff()}handleNoteMatch(t,e){this.isHolding||(this.isHolding=!0,this.holdStartTime=Date.now(),this.holdSamples=[],this.attempts++),this.holdSamples.push({cents:e.cents,confidence:t.confidence,timestamp:Date.now()}),this.config.onProgress({isHolding:!0,holdDuration:Date.now()-this.holdStartTime,requiredDuration:this.config.holdTime,progress:Math.min((Date.now()-this.holdStartTime)/this.config.holdTime,1),currentCents:e.cents});return Date.now()-this.holdStartTime>=this.config.holdTime?this.completeHold():{stateChanged:!1}}handleNoteOff(){return this.isHolding&&(this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.config.onProgress({isHolding:!1,holdDuration:0,requiredDuration:this.config.holdTime,progress:0})),{stateChanged:!1}}completeHold(){const t=this.holdSamples.length>0?this.holdSamples.reduce((t,e)=>t+e.cents,0)/this.holdSamples.length:0,e=Math.abs(t);return this.successfulHits++,this.totalHoldTime+=Date.now()-this.holdStartTime,this.statistics.hits++,this.statistics.totalCents+=e,(null===this.bestAccuracy||e<Math.abs(this.bestAccuracy))&&(this.bestAccuracy=t,this.statistics.bestCents=t),this.config.onNoteHit({note:this.config.targetNote,averageCents:t,holdDuration:Date.now()-this.holdStartTime,attempt:this.attempts}),this.isHolding=!1,this.holdStartTime=null,this.holdSamples=[],this.config.onProgress({isHolding:!1,holdDuration:0,requiredDuration:this.config.holdTime,progress:0}),{stateChanged:!1,noteCompleted:!0}}setTargetNote(t){this.config.targetNote=t,this.resetStatistics()}getTargetNote(){return this.config.targetNote}getHoldProgress(){if(!this.isHolding||!this.holdStartTime)return 0;const t=Date.now()-this.holdStartTime;return Math.min(t/this.config.holdTime,1)}getStatistics(){const t=this.attempts>0?this.successfulHits/this.attempts*100:0,e=this.successfulHits>0?this.statistics.totalCents/this.successfulHits:0;return{targetNote:this.config.targetNote,attempts:this.attempts,successfulHits:this.successfulHits,successRate:Math.round(t),averageAccuracy:Math.round(10*e)/10,bestAccuracy:null!==this.bestAccuracy?Math.round(10*Math.abs(this.bestAccuracy))/10:null,totalPracticeTime:this.totalHoldTime}}resetStatistics(){this.attempts=0,this.successfulHits=0,this.totalHoldTime=0,this.bestAccuracy=null,this.statistics={attempts:0,hits:0,totalCents:0,bestCents:null}}getStateForPersistence(){return{targetNote:this.config.targetNote,tolerance:this.config.tolerance,attempts:this.attempts,successfulHits:this.successfulHits,bestAccuracy:this.bestAccuracy,statistics:this.statistics}}restore(t){this.config.targetNote=t.targetNote||"C4",this.config.tolerance=t.tolerance||25,this.attempts=t.attempts||0,this.successfulHits=t.successfulHits||0,this.bestAccuracy=t.bestAccuracy||null,this.statistics=t.statistics||{attempts:0,hits:0,totalCents:0,bestCents:null}}getState(){return"active"}}const u=700,m=600,g=500,d=400,S=300,p={maxCents:10,points:100},f={maxCents:25,points:75},C={maxCents:50,points:50};class N{constructor(){this.notes=[],this.currentCombo=0,this.maxCombo=0,this.totalScore=0,this.perfectCount=0,this.greatCount=0,this.okCount=0,this.missCount=0}addNote(t,e,s){if(!s)return this.notes.push({tier:"MISS",points:0,comboBonus:0,totalPoints:0,avgCents:t,timeToHit:e}),this.missCount++,this.currentCombo=0,{tier:"MISS",points:0,comboBonus:0,totalPoints:0,combo:0};const i=Math.abs(t);let o,r;i<=p.maxCents?(o="PERFECT",r=p.points,this.perfectCount++):i<=f.maxCents?(o="GREAT",r=f.points,this.greatCount++):i<=C.maxCents?(o="OK",r=C.points,this.okCount++):(o="MISS",r=0,this.missCount++),"PERFECT"===o?(this.currentCombo++,this.maxCombo=Math.max(this.maxCombo,this.currentCombo)):this.currentCombo=0;const n=this.calculateComboBonus(this.currentCombo),a=this.calculateTimeBonus(e),h=r+n+a;return this.notes.push({tier:o,points:r,comboBonus:n,timeBonus:a,totalPoints:h,avgCents:t,timeToHit:e}),this.totalScore+=h,{tier:o,points:r,comboBonus:n,timeBonus:a,totalPoints:h,combo:this.currentCombo}}calculateComboBonus(t){return t<2?0:t<4?5:t<6?10:t<8?15:20}calculateTimeBonus(t){return t<2e3?10:t<3e3?5:0}getFinalScore(){return this.totalScore}getGrade(){return this.totalScore>=u?"S":this.totalScore>=m?"A":this.totalScore>=g?"B":this.totalScore>=d?"C":this.totalScore>=S?"D":"F"}getStatistics(){const t=this.notes.length,e=t>0?(this.perfectCount+this.greatCount+this.okCount)/t*100:0;return{totalScore:this.totalScore,grade:this.getGrade(),totalNotes:t,perfectCount:this.perfectCount,greatCount:this.greatCount,okCount:this.okCount,missCount:this.missCount,maxCombo:this.maxCombo,accuracy:Math.round(e),averageCents:this.getAverageCents()}}getAverageCents(){const t=this.notes.filter(t=>"MISS"!==t.tier);if(0===t.length)return 0;const e=t.reduce((t,e)=>t+Math.abs(e.avgCents),0);return Math.round(e/t.length*10)/10}getState(){return{notes:this.notes,currentCombo:this.currentCombo,maxCombo:this.maxCombo,totalScore:this.totalScore,perfectCount:this.perfectCount,greatCount:this.greatCount,okCount:this.okCount,missCount:this.missCount}}restore(t){this.notes=t.notes||[],this.currentCombo=t.currentCombo||0,this.maxCombo=t.maxCombo||0,this.totalScore=t.totalScore||0,this.perfectCount=t.perfectCount||0,this.greatCount=t.greatCount||0,this.okCount=t.okCount||0,this.missCount=t.missCount||0}reset(){this.notes=[],this.currentCombo=0,this.maxCombo=0,this.totalScore=0,this.perfectCount=0,this.greatCount=0,this.okCount=0,this.missCount=0}}const y="scale-climber-session",T="scale-climber-high-scores",b="scale-climber-settings";class M{constructor(){this.hasSessionStorage=this.checkStorageAvailability("sessionStorage"),this.hasLocalStorage=this.checkStorageAvailability("localStorage")}checkStorageAvailability(t){try{const e=window[t],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),!0}catch(e){return!1}}saveSession(t){if(!this.hasSessionStorage)return!1;try{const e={...t,timestamp:Date.now(),version:"1.0"};return sessionStorage.setItem(y,JSON.stringify(e)),!0}catch(e){return console.error("Failed to save session:",e),!1}}loadSession(){if(!this.hasSessionStorage)return null;try{const t=sessionStorage.getItem(y);if(!t)return null;const e=JSON.parse(t);return Date.now()-e.timestamp>36e5?(this.clearSession(),null):e.mode&&e.config?e:null}catch(t){return console.error("Failed to load session:",t),null}}clearSession(){if(this.hasSessionStorage)try{sessionStorage.removeItem(y)}catch(t){console.error("Failed to clear session:",t)}}hasSession(){if(!this.hasSessionStorage)return!1;return null!==this.loadSession()}saveHighScore(t,e,s={}){if(!this.hasLocalStorage)return!1;try{const i=this.getHighScores(),o={score:t,grade:e,timestamp:Date.now(),date:(new Date).toISOString(),...s};i.push(o),i.sort((t,e)=>e.score-t.score);const r=i.slice(0,10);return localStorage.setItem(T,JSON.stringify(r)),r.some(t=>t.timestamp===o.timestamp)}catch(i){return console.error("Failed to save high score:",i),!1}}getHighScores(){if(!this.hasLocalStorage)return[];try{const t=localStorage.getItem(T);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.error("Failed to load high scores:",t),[]}}getPersonalBest(){const t=this.getHighScores();return 0===t.length?0:t[0].score}clearHighScores(){if(this.hasLocalStorage)try{localStorage.removeItem(T)}catch(t){console.error("Failed to clear high scores:",t)}}saveSettings(t){if(this.hasLocalStorage)try{localStorage.setItem(b,JSON.stringify(t))}catch(e){console.error("Failed to save settings:",e)}}loadSettings(){if(!this.hasLocalStorage)return this.getDefaultSettings();try{const t=localStorage.getItem(b);if(!t)return this.getDefaultSettings();const e=JSON.parse(t);return{...this.getDefaultSettings(),...e}}catch(t){return console.error("Failed to load settings:",t),this.getDefaultSettings()}}getDefaultSettings(){return{volume:.7,difficulty:"normal",octave:4,showReferenceTone:!0,autoCalibrate:!0,theme:"dark"}}clearAll(){if(this.clearSession(),this.clearHighScores(),this.hasLocalStorage)try{localStorage.removeItem(b)}catch(t){console.error("Failed to clear settings:",t)}}getStorageInfo(){return{sessionStorage:this.hasSessionStorage,localStorage:this.hasLocalStorage,hasSession:this.hasSession(),highScoreCount:this.getHighScores().length,personalBest:this.getPersonalBest()}}}class H{constructor(){this.audioManager=null,this.pitchDetector=null,this.calibrationEngine=null,this.currentMode=null,this.scoreSystem=new N,this.stateRecovery=new M,this.state="idle",this.subState=null,this.currentNote=0,this.lastPitchResult=null,this.frameTime=0,this.listeners=new Map,this.gameLoopId=null,this.isPaused=!1}async initialize(){try{this.audioManager=t.getInstance();const i=await this.audioManager.initialize();return i.success?(this.pitchDetector=new e(this.audioManager),await this.pitchDetector.init(),this.calibrationEngine=new s(this.pitchDetector),{success:!0}):{success:!1,error:i.error}}catch(i){return console.error("GameEngine initialization error:",i),{success:!1,error:"INITIALIZATION_FAILED",message:i.message}}}async startCalibration(t){this.state="calibration";const e=await this.calibrationEngine.start(t);return e.success?this.emit("calibration-complete",e):this.emit("calibration-failed",e),e}startChallenge(t=4,e="normal"){this.state="countdown",this.scoreSystem.reset(),this.currentMode=new c({octave:t,difficulty:e,onNoteHit:t=>this.handleNoteHit(t),onNoteMiss:t=>this.handleNoteMiss(t),onComplete:()=>this.handleChallengeComplete(),onFail:t=>this.handleChallengeFail(t),onProgress:t=>this.emit("challenge-progress",t)}),this.emit("countdown-start");let s=3;const i=setInterval(()=>{this.emit("countdown-tick",s),s--,s<0&&(clearInterval(i),this.state="playing",this.currentMode.start(),this.startGameLoop(),this.emit("game-start"))},1e3)}startPractice(t="C4",e="normal"){this.state="playing";this.currentMode=new l({targetNote:t,tolerance:{easy:50,normal:25,hard:10}[e],holdTime:1500,onNoteHit:t=>{this.emit("practice-note-hit",t)},onProgress:t=>{this.emit("practice-progress",t)}}),this.currentMode.start(),this.startGameLoop(),this.emit("practice-start",{targetNote:t})}async startGameLoop(){const t=async()=>{if("playing"!==this.state||this.isPaused)return;const e=performance.now();try{if(this.lastPitchResult=await this.pitchDetector.detect(),this.currentMode){const t=this.currentMode.update(this.lastPitchResult);t.stateChanged&&(this.subState=t.newState),t.noteCompleted&&this.emit("note-completed",{currentNote:this.currentMode.getCurrentNote?.(),holdProgress:this.currentMode.getHoldProgress?.()||0})}this.emit("pitch-update",{...this.lastPitchResult,targetNote:this.currentMode?.getCurrentNote?.()||null,holdProgress:this.currentMode?.getHoldProgress?.()||0}),"practice"!==this.currentMode?.type&&e%5e3<16&&this.saveGameState()}catch(s){console.error("Game loop error:",s)}this.frameTime=performance.now()-e,this.gameLoopId=requestAnimationFrame(t)};this.gameLoopId=requestAnimationFrame(t)}stopGameLoop(){this.gameLoopId&&(cancelAnimationFrame(this.gameLoopId),this.gameLoopId=null)}handleNoteHit(t){const e=this.scoreSystem.addNote(t.averageCents,t.timeToHit,!0);this.currentNote++,this.emit("note-hit",{noteData:t,score:e})}handleNoteMiss(t){this.scoreSystem.addNote(0,0,!1),this.emit("note-miss",{noteData:t})}handleChallengeComplete(){this.state="complete",this.stopGameLoop();const t=this.scoreSystem.getFinalScore(),e=this.scoreSystem.getGrade(),s=this.scoreSystem.getStatistics();this.stateRecovery.saveHighScore(t,e,{...s,mode:"challenge",octave:this.currentMode.config.octave,difficulty:this.currentMode.config.difficulty}),this.stateRecovery.clearSession(),this.emit("challenge-complete",{finalScore:t,grade:e,statistics:s})}handleChallengeFail(t){this.state="failed",this.stopGameLoop(),this.stateRecovery.clearSession(),this.emit("challenge-failed",{reason:t})}pause(){"playing"===this.state&&(this.isPaused=!0,this.state="paused",this.saveGameState(),this.emit("game-paused"))}resume(){"paused"===this.state&&(this.isPaused=!1,this.state="playing",this.startGameLoop(),this.emit("game-resumed"))}stop(){this.stopGameLoop(),this.state="idle",this.currentMode=null,this.emit("game-stopped")}saveGameState(){this.currentMode&&"practice"!==this.currentMode.type&&this.stateRecovery.saveSession({mode:"challenge",modeState:this.currentMode.getStateForPersistence(),score:this.scoreSystem.getState(),currentNote:this.currentNote,config:this.currentMode.config,timestamp:Date.now()})}hasSavedSession(){return this.stateRecovery.hasSession()}async resumeSession(){const t=this.stateRecovery.loadSession();return t?("challenge"===t.mode&&(this.currentMode=new c(t.config),this.currentMode.restore(t.modeState)),this.scoreSystem.restore(t.score),this.currentNote=t.currentNote,this.state="playing",this.startGameLoop(),{success:!0}):{success:!1,error:"NO_SAVED_SESSION"}}getState(){return this.state}getLastPitchResult(){return this.lastPitchResult}getCurrentScore(){return this.scoreSystem.getFinalScore()}getScoreStatistics(){return this.scoreSystem.getStatistics()}getHighScores(){return this.stateRecovery.getHighScores()}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!this.listeners.has(t))return;const s=this.listeners.get(t),i=s.indexOf(e);i>-1&&s.splice(i,1)}emit(t,e){if(!this.listeners.has(t))return;this.listeners.get(t).forEach(s=>{try{s(e)}catch(i){console.error(`Error in event listener for ${t}:`,i)}})}async destroy(){this.stopGameLoop(),this.pitchDetector&&this.pitchDetector.destroy(),this.audioManager&&await this.audioManager.destroy(),this.listeners.clear()}}export{H as G,n as g};
