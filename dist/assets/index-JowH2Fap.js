import{G as e}from"./game-logic-DIPB9U6A.js";import{C as t,a as i,P as s,b as n}from"./visuals-DAVB2UIO.js";import"./audio-D-pHvAC-.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const o={Tab:"navigate",Enter:"confirm"," ":"pause",Escape:"back",r:"restart",R:"restart",m:"mute",M:"mute",h:"toggleHUD",H:"toggleHUD",1:"octave1",2:"octave2",3:"octave3",4:"octave4",p:"practice",P:"practice","?":"help"};class a{constructor(e,t={}){this.gameEngine=e,this.enabled=!0,this.helpVisible=!1,this.hudVisible=!0,this.callbacks={onHelp:t.onHelp||null,onHUDToggle:t.onHUDToggle||null},this.setupListeners()}setupListeners(){document.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){if(!this.enabled)return;const t=o[e.key];t&&("Tab"!==e.key&&e.preventDefault(),this.handleAction(t,e))}handleAction(e){const t=this.gameEngine?.state||"idle";switch(e){case"pause":"playing"===t?(this.gameEngine.pause(),this.announceToScreenReader("Game paused")):"paused"===t&&(this.gameEngine.resume(),this.announceToScreenReader("Game resumed"));break;case"back":"playing"===t&&(this.gameEngine.pause(),this.announceToScreenReader("Game paused"));break;case"restart":"paused"!==t&&"results"!==t&&"failed"!==t||(this.gameEngine.restart(),this.announceToScreenReader("Restarting game"));break;case"mute":{const e=this.gameEngine.toggleMute();this.announceToScreenReader(e?"Audio muted":"Audio unmuted");break}case"toggleHUD":this.hudVisible=!this.hudVisible,this.callbacks.onHUDToggle&&this.callbacks.onHUDToggle(this.hudVisible),this.announceToScreenReader(this.hudVisible?"HUD shown":"HUD hidden");break;case"help":this.helpVisible=!this.helpVisible,this.callbacks.onHelp&&this.callbacks.onHelp(this.helpVisible);break;case"practice":if("idle"===t||"menu"===t){const e=document.getElementById("practice-button");e&&e.click()}break;case"octave1":case"octave2":case"octave3":case"octave4":{const t=e.slice(-1);this.handleOctaveSelect(t);break}}}handleOctaveSelect(e){console.log(`Octave ${e} selected`)}announceToScreenReader(e){const t=document.getElementById("status-announce")||this.createAnnouncer();t.textContent="",setTimeout(()=>{t.textContent=e},100)}createAnnouncer(){const e=document.createElement("div");return e.id="status-announce",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",document.body.appendChild(e),e}enable(){this.enabled=!0}disable(){this.enabled=!1}getHelpText(){return[{key:"Space",action:"Pause/Resume",description:"Toggle game pause"},{key:"Esc",action:"Back",description:"Pause game or go back"},{key:"R",action:"Restart",description:"Restart current challenge"},{key:"M",action:"Mute",description:"Toggle audio mute"},{key:"H",action:"Toggle HUD",description:"Show/hide game overlay"},{key:"P",action:"Practice",description:"Start practice mode"},{key:"1-4",action:"Select Octave",description:"Quick octave selection"},{key:"?",action:"Help",description:"Show/hide this help"},{key:"Tab",action:"Navigate",description:"Move focus to next element"},{key:"Enter",action:"Confirm",description:"Activate focused button"}]}destroy(){document.removeEventListener("keydown",this.handleKeyDown)}}class r{constructor(){this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.loadSettings(),this.setupMediaQueryListeners()}setupMediaQueryListeners(){const e=window.matchMedia("(prefers-reduced-motion: reduce)");e.addEventListener?e.addEventListener("change",e=>{this.prefersReducedMotion=e.matches,this.applySettings()}):e.addListener(e=>{this.prefersReducedMotion=e.matches,this.applySettings()})}loadSettings(){try{const e=JSON.parse(localStorage.getItem("accessibility_settings"));e&&(this.highContrastMode=e.highContrast||!1,this.colorblindMode=e.colorblindMode||"none",this.focusVisible=!1!==e.focusVisible)}catch{}this.applySettings()}saveSettings(){try{localStorage.setItem("accessibility_settings",JSON.stringify({highContrast:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}))}catch(e){console.warn("Failed to save accessibility settings:",e)}this.applySettings()}applySettings(){document.body.classList.toggle("reduced-motion",this.prefersReducedMotion),document.body.classList.toggle("high-contrast",this.highContrastMode),document.body.dataset.colorblindMode=this.colorblindMode,document.body.classList.toggle("focus-visible",this.focusVisible),this.emit("settingsChanged",this.getSettings())}getSettings(){return{prefersReducedMotion:this.prefersReducedMotion,highContrastMode:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}}toggleHighContrast(){return this.highContrastMode=!this.highContrastMode,this.saveSettings(),this.highContrastMode}setColorblindMode(e){["none","deuteranopia","protanopia","tritanopia"].includes(e)?(this.colorblindMode=e,this.saveSettings()):console.warn(`Invalid colorblind mode: ${e}`)}getAdjustedColor(e){if("none"===this.colorblindMode&&!this.highContrastMode)return e;if(this.highContrastMode){return{perfect:"#00FF00",great:"#FFFF00",good:"#FFA500",ok:"#FF6600",miss:"#FF0000"}[e]||e}const t={deuteranopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#FF0066"},protanopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#8800FF"},tritanopia:{perfect:"#FF00FF",great:"#00FFFF",good:"#FF8800",ok:"#FF6600",miss:"#FF0000"}}[this.colorblindMode];return t&&t[e]||e}shouldReduceMotion(){return this.prefersReducedMotion}emit(e,t){const i=new CustomEvent(`accessibility:${e}`,{detail:t});document.dispatchEvent(i)}on(e,t){document.addEventListener(`accessibility:${e}`,e=>{t(e.detail)})}getColorblindModeDescription(){return{none:"Standard colors",deuteranopia:"Red-green colorblindness (Deuteranopia)",protanopia:"Red-blind (Protanopia)",tritanopia:"Blue-yellow colorblindness (Tritanopia)"}[this.colorblindMode]||"Unknown"}reset(){this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.saveSettings()}}class l{constructor(){this.sounds=new Map,this.volume=.7,this.muted=!1,this.loadingPromises=[],this.loadSounds()}async loadSounds(){const e="/scale-climber/",t={perfect:`${e}assets/sounds/perfect.opus`,great:`${e}assets/sounds/great.opus`,ok:`${e}assets/sounds/ok.opus`,miss:`${e}assets/sounds/miss.opus`,combo:`${e}assets/sounds/combo.opus`,victory:`${e}assets/sounds/victory.opus`,failure:`${e}assets/sounds/failure.opus`,click:`${e}assets/sounds/click.opus`},i={perfect:this.createSilentAudio(),great:this.createSilentAudio(),ok:this.createSilentAudio(),miss:this.createSilentAudio(),combo:this.createSilentAudio(),victory:this.createSilentAudio(),failure:this.createSilentAudio(),click:this.createSilentAudio()};for(const[s,n]of Object.entries(t)){const e=this.loadSound(s,n,i[s]);this.loadingPromises.push(e)}return Promise.all(this.loadingPromises)}async loadSound(e,t,i){try{const s=new Audio;return s.volume=this.volume,s.preload="auto",new Promise(n=>{s.addEventListener("canplaythrough",()=>{this.sounds.set(e,s),n()}),s.addEventListener("error",()=>{console.warn(`Failed to load sound: ${e}, using silent fallback`),this.sounds.set(e,i),n()}),s.src=t})}catch(s){return console.warn(`Failed to load sound: ${e}`,s),this.sounds.set(e,i),Promise.resolve()}}createSilentAudio(){const e=new Audio;return e.src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=",e.volume=0,e}play(e,t=1){if(this.muted)return;const i=this.sounds.get(e);if(i)try{const e=i.cloneNode();e.volume=this.volume*t,e.play().catch(e=>{console.debug("Failed to play sound:",e)})}catch(s){console.debug("Error playing sound:",s)}else console.warn(`Sound not found: ${e}`)}playNoteResult(e){const t={PERFECT:"perfect",GREAT:"great",OK:"ok",MISS:"miss"}[e];t&&this.play(t)}playCombo(e){e>0&&e%5==0&&this.play("combo",.8)}playClick(){this.play("click",.5)}playVictory(){this.play("victory",.9)}playFailure(){this.play("failure",.9)}setVolume(e){this.volume=Math.max(0,Math.min(1,e));for(const t of this.sounds.values())t.volume=this.volume}getVolume(){return this.volume}setMuted(e){this.muted=e}toggleMute(){return this.muted=!this.muted,this.muted}isMuted(){return this.muted}stopAll(){for(const e of this.sounds.values())e.pause(),e.currentTime=0}async waitForLoad(){return Promise.all(this.loadingPromises)}}class c{constructor(){this.audioContext=null,this.enabled=!1,this.volume=.3,this.oscillatorType="sine"}initialize(){if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;e?this.audioContext=new e:console.warn("Web Audio API not supported")}}playNote(e,t=500){if(this.enabled&&(this.audioContext||this.initialize(),this.audioContext))try{"suspended"===this.audioContext.state&&this.audioContext.resume();const i=this.audioContext.createOscillator(),s=this.audioContext.createGain();i.connect(s),s.connect(this.audioContext.destination),i.frequency.setValueAtTime(e,this.audioContext.currentTime),i.type=this.oscillatorType;const n=this.audioContext.currentTime,o=t/1e3;s.gain.setValueAtTime(0,n),s.gain.linearRampToValueAtTime(this.volume,n+.05),s.gain.setValueAtTime(this.volume,n+o-.1),s.gain.linearRampToValueAtTime(0,n+o),i.start(n),i.stop(n+o),i.addEventListener("ended",()=>{i.disconnect(),s.disconnect()})}catch(i){console.warn("Failed to play reference tone:",i)}}playNoteName(e,t=500){const i=this.noteToFrequency(e);i&&this.playNote(i,t)}async playSequence(e,t=100){if(this.enabled)for(const i of e)i.noteName?this.playNoteName(i.noteName,i.duration||500):i.frequency&&this.playNote(i.frequency,i.duration||500),await this.delay((i.duration||500)+t)}noteToFrequency(e){const t=e.match(/^([A-G])([#b]?)(\d)$/);if(!t)return console.warn(`Invalid note name: ${e}`),null;const[,i,s,n]=t;let o={C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2}[i];return"#"===s&&(o+=1),"b"===s&&(o-=1),o+=12*(parseInt(n,10)-4),440*2**(o/12)}enable(){this.enabled=!0,this.audioContext||this.initialize()}disable(){this.enabled=!1}toggle(){return this.enabled?this.disable():this.enable(),this.enabled}isEnabled(){return this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}getVolume(){return this.volume}setOscillatorType(e){["sine","square","sawtooth","triangle"].includes(e)&&(this.oscillatorType=e)}delay(e){return new Promise(t=>setTimeout(t,e))}destroy(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}class d{constructor(e,t){this.canvas=e,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!1}),this.character=t,this.width=0,this.height=0,this.time=0,this.orbState={x:0,y:0,radius:10,color:"#FFFFFF",alpha:0,targetX:0,targetY:0,blur:0},this.campfireState={intensity:.5,particles:[]},this.auroraPoints=[],this.nodes=[],this.initAurora(),this.setupResize(),this.resize()}initAurora(){this.auroraPoints=[];for(let e=0;e<=10;e++)this.auroraPoints.push({x:e/10,y:.2+.1*Math.random(),offset:Math.random()*Math.PI*2})}setupResize(){window.addEventListener("resize",()=>this.resize())}resize(){const e=this.canvas.parentElement;if(e){this.width=e.clientWidth,this.height=e.clientHeight,this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.top="0";const t=window.devicePixelRatio||1;this.canvas.width=this.width*t,this.canvas.height=this.height*t,this.ctx.scale(t,t),this.recalculateNodePositions()}}recalculateNodePositions(){this.nodes=[{note:"C4",x:.25,y:.75,label:"C"},{note:"D4",x:.35,y:.65,label:"D"},{note:"E4",x:.45,y:.58,label:"E"},{note:"F4",x:.55,y:.5,label:"F"},{note:"G4",x:.65,y:.42,label:"G"},{note:"A4",x:.75,y:.35,label:"A"},{note:"B4",x:.82,y:.28,label:"B"},{note:"C5",x:.9,y:.2,label:"C"}]}update(e,t){if(this.time+=e,this.auroraPoints.forEach((e,t)=>{e.y=.2+.05*Math.sin(.5*this.time+e.offset+.5*t)}),t.volume>.01?Math.random()<2*t.volume&&this.campfireState.particles.push({x:.2*this.width,y:.8*this.height,vx:20*(Math.random()-.5),vy:50*-Math.random()-100*t.volume,life:1,size:3*Math.random()+2}):Math.random()<.1&&this.campfireState.particles.push({x:.2*this.width,y:.8*this.height,vx:10*(Math.random()-.5),vy:30*-Math.random(),life:1,size:2*Math.random()+1}),this.campfireState.particles.forEach(t=>{t.x+=t.vx*e,t.y+=t.vy*e,t.life-=e,t.size*=.95}),this.campfireState.particles=this.campfireState.particles.filter(e=>e.life>0),null!==t.pitchCents&&void 0!==t.pitchCents){const i=this.nodes[0],s=i.x*this.width,n=i.y*this.height,o=100,a=t.pitchCents/50*o,r=-t.pitchCents/50*(.5*o);this.orbState.targetX=s+a,this.orbState.targetY=n+r,this.orbState.alpha=Math.min(t.confidence||0,1);const l=5*e;this.orbState.x+=(this.orbState.targetX-this.orbState.x)*l,this.orbState.y+=(this.orbState.targetY-this.orbState.y)*l,this.orbState.blur=20*(1-(t.confidence||0))}else this.orbState.alpha*=.9}render(e){this.ctx.fillStyle="#050B14",this.ctx.fillRect(0,0,this.width,this.height),this.renderAurora(),this.renderMountains(),this.renderNodes(e),this.renderCampfire(),this.renderClimber(),this.renderOrb(),(e.isClippingIn||e.clipProgress>0)&&this.renderClipIn(e)}renderAurora(){const{ctx:e}=this;e.save();const t=e.createLinearGradient(0,0,this.width,0);t.addColorStop(0,"rgba(0, 255, 128, 0)"),t.addColorStop(.5,"rgba(0, 255, 128, 0.2)"),t.addColorStop(1,"rgba(0, 255, 128, 0)"),e.fillStyle=t,e.beginPath(),e.moveTo(0,0),this.auroraPoints.forEach(t=>{e.lineTo(t.x*this.width,t.y*this.height)}),e.lineTo(this.width,0),e.fill(),e.restore()}renderMountains(){const{ctx:e}=this;e.fillStyle="#0F1A2A",e.beginPath(),e.moveTo(0,this.height),e.lineTo(0,.6*this.height),e.lineTo(.5*this.width,.3*this.height),e.lineTo(this.width,.5*this.height),e.lineTo(this.width,this.height),e.fill(),e.fillStyle="#162438",e.beginPath(),e.moveTo(0,this.height),e.lineTo(0,.8*this.height),e.lineTo(.3*this.width,.5*this.height),e.lineTo(.7*this.width,.7*this.height),e.lineTo(this.width,.6*this.height),e.lineTo(this.width,this.height),e.fill()}renderNodes(e){const{ctx:t}=this;if(!e.nodesVisible){const e=this.nodes[0];return t.fillStyle="rgba(255, 255, 255, 0.1)",t.beginPath(),t.arc(e.x*this.width,e.y*this.height,5,0,2*Math.PI),void t.fill()}t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=2,t.beginPath(),this.nodes.forEach((e,i)=>{0===i?t.moveTo(e.x*this.width,e.y*this.height):t.lineTo(e.x*this.width,e.y*this.height)}),t.stroke(),this.nodes.forEach(e=>{t.fillStyle="rgba(255, 255, 255, 0.8)",t.beginPath(),t.arc(e.x*this.width,e.y*this.height,6,0,2*Math.PI),t.fill()})}renderCampfire(){const{ctx:e}=this;e.globalCompositeOperation="screen",this.campfireState.particles.forEach(t=>{e.fillStyle=`rgba(255, 150, 50, ${t.life})`,e.beginPath(),e.arc(t.x,t.y,t.size,0,2*Math.PI),e.fill()}),e.globalCompositeOperation="source-over",e.fillStyle="#FF4500",e.beginPath(),e.arc(.2*this.width,.8*this.height,5+2*Math.random(),0,2*Math.PI),e.fill()}renderClimber(){const{ctx:e}=this,t=.2*this.width-20,i=.8*this.height-40;e.fillStyle="#000",e.fillRect(t,i,20,40)}renderOrb(){if(this.orbState.alpha<=.01)return;const{ctx:e}=this;e.save(),e.globalAlpha=this.orbState.alpha,e.shadowColor=this.orbState.color,e.shadowBlur=10+5*Math.random(),e.fillStyle=this.orbState.color,e.beginPath(),e.arc(this.orbState.x,this.orbState.y,this.orbState.radius,0,2*Math.PI),e.fill(),this.orbState.blur>5&&(e.shadowBlur=this.orbState.blur,e.fillStyle="rgba(255, 255, 255, 0.3)",e.fill()),e.restore()}renderClipIn({clipProgress:e}){const{ctx:t}=this,i=this.nodes[0],s=i.x*this.width,n=i.y*this.height;e>0&&(t.strokeStyle="#00FF88",t.lineWidth=4,t.beginPath(),t.arc(s,n,20,-Math.PI/2,-Math.PI/2+2*Math.PI*e),t.stroke())}}const h="IDLE",u="NEED_MIC",m="REQUESTING_MIC",g="LISTENING",p="TOO_QUIET",b="PITCH_UNCERTAIN",y="CLIP_IN_ARMED",f="CLIP_IN_HOLDING",v="CLIP_IN_SUCCESS",S="STARTING",C="ERROR_MIC_DENIED";class E{constructor(e){this.gameEngine=e,this.renderer=null,this.canvas=null,this.currentState=h,this.stateStartTime=0,this.holdStartTime=0,this.holdDuration=1500,this.holdProgress=0,this.rafId=null,this.lastFrameTime=0,this.ui={container:null,headline:null,subhead:null,ctaBtn:null,ctaHelper:null,voiceHint:null,srStatus:null},this.onStartGame=null}init(e,t){this.onStartGame=t,this.ui.container=document.getElementById(e),this.ui.container&&(this.ui.headline=this.ui.container.querySelector("#ts-headline"),this.ui.subhead=this.ui.container.querySelector("#ts-subhead"),this.ui.ctaBtn=this.ui.container.querySelector("#ts-cta-btn"),this.ui.ctaHelper=this.ui.container.querySelector("#ts-cta-helper"),this.ui.voiceHint=this.ui.container.querySelector("#ts-voice-hint"),this.ui.srStatus=this.ui.container.querySelector("#ts-sr-status"),this.canvas=document.getElementById("title-canvas"),this.renderer=new d(this.canvas,null),this.setState(u),this.ui.ctaBtn.addEventListener("click",()=>this.handleCtaClick()),this.startLoop())}handleCtaClick(){this.currentState===u||this.currentState===C?this.requestMic():this.currentState===v&&this.startGame()}async requestMic(){this.setState(m);try{(await this.gameEngine.initialize()).success?(this.setState(g),await this.gameEngine.audioManager.resume()):this.setState(C)}catch(e){console.error(e),this.setState(C)}}setState(e){this.currentState!==e&&(this.currentState=e,this.stateStartTime=performance.now(),this.updateUI())}updateUI(){const e=this.currentState,{ui:t}=this,i=(e,t)=>{e&&(e.textContent=t)};switch(e){case u:i(t.headline,"MIC ON = GAME ON."),i(t.subhead,"Enable your mic to start the climb."),i(t.ctaBtn,"Enable mic"),i(t.ctaHelper,"No mic, no magic."),t.ctaBtn.disabled=!1;break;case m:i(t.headline,"POWER UP!"),i(t.subhead,"Hit â€œAllowâ€ in the browser prompt."),i(t.ctaBtn,"Waiting..."),i(t.ctaHelper,"Look near the address bar if you missed it."),t.ctaBtn.disabled=!0;break;case g:i(t.headline,"DROP A NOTE."),i(t.subhead,"Hold it steady to clip in."),i(t.ctaBtn,"Hum to clip in"),i(t.ctaHelper,"Any comfy note. Just keep it smooth."),i(t.voiceHint,"Try â€œooâ€ â†’"),t.ctaBtn.disabled=!0;break;case p:i(t.headline,"SPEAK UP, CHAMP."),i(t.subhead,"A bit louderâ€”or move closer to the mic."),i(t.voiceHint,"Closer = better");break;case b:i(t.headline,"GIVE ME A CLEAN TONE."),i(t.subhead,"One long â€œooâ€ works best."),i(t.voiceHint,"Looong â€œooâ€â€¦");break;case y:i(t.headline,"RIGHT ON IT!"),i(t.subhead,"Now HOLD. Donâ€™t flinch.");break;case f:i(t.headline,"LOCKING INâ€¦"),i(t.subhead,"Keep it pinned."),i(t.ctaBtn,"Lockingâ€¦"),i(t.ctaHelper,"Youâ€™re cooking."),i(t.voiceHint,"Steady!");break;case v:i(t.headline,"LOCKED!"),i(t.subhead,"Route unlocked. Time to climb."),i(t.ctaBtn,"Start climb"),i(t.ctaHelper,"Sing the scale to hit the summit."),i(t.voiceHint,""),t.ctaBtn.disabled=!1,t.ctaBtn.classList.add("pulse-success");break;case C:i(t.headline,"NO MIC, NO CLIMB."),i(t.subhead,"Enable mic access to play."),i(t.ctaBtn,"Try again"),i(t.ctaHelper,"You can flip it in your browser settings."),t.ctaBtn.disabled=!1}}startLoop(){this.lastFrameTime=performance.now();const e=()=>{const t=performance.now(),i=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this.update(i),this.render(),this.currentState!==S&&(this.rafId=requestAnimationFrame(e))};this.rafId=requestAnimationFrame(e)}async update(e){let t=null,i=0;this.gameEngine.pitchDetector&&(t=await this.gameEngine.pitchDetector.detect(),i=t?.volume||0),this.currentState!==u&&this.currentState!==m&&this.currentState!==v&&this.currentState!==C&&this.processAudioInput(t,i),this.rendererState={volume:i,pitchCents:t?.diff,confidence:t?.clarity,isClippingIn:this.currentState===f,clipProgress:this.holdProgress,nodesVisible:this.currentState===v},t&&(this.rendererState.pitchCents=this.calculateTargetDiff(t)),this.renderer.update(e,this.rendererState)}calculateTargetDiff(e){return e.diff}processAudioInput(e,t){if(!e)return;const{diff:i,clarity:s}=e;if(t<.02)return this.setState(p),void this.resetHold();if(s<.9)return this.setState(b),void this.resetHold();if(Math.abs(i)<25){this.currentState!==f&&(this.setState(y),this.setState(f),this.holdStartTime=performance.now());const e=performance.now()-this.holdStartTime;this.holdProgress=Math.min(e/this.holdDuration,1),this.holdProgress>=1&&this.setState(v)}else this.currentState===f&&this.setState(g),this.resetHold()}resetHold(){this.holdProgress=0,this.currentState===f&&this.setState(g)}render(){this.renderer&&this.renderer.render(this.rendererState||{})}startGame(){this.setState(S),cancelAnimationFrame(this.rafId),this.ui.container.classList.add("hidden"),this.onStartGame&&this.onStartGame()}destroy(){cancelAnimationFrame(this.rafId)}}let w=null,M=null,k=null,I=null;const A={loading:document.getElementById("loading-screen"),start:document.getElementById("start-screen"),"title-screen-layer":document.getElementById("title-screen-layer"),"calibration-ready":document.getElementById("calibration-ready-screen"),calibration:document.getElementById("calibration-screen"),game:document.getElementById("game-screen"),results:document.getElementById("results-screen"),error:document.getElementById("error-screen")};function T(e){Object.values(A).forEach(e=>{e&&e.classList.remove("active")});const t=A[e];t&&("title-screen-layer"===e?t.style.display="flex":(t.classList.add("active"),A["title-screen-layer"]&&(A["title-screen-layer"].style.display="none"))),"game"===e&&M?(M.resize(),M.start()):M&&M.stop()}function F(e){document.getElementById("error-message").textContent=e,T("error")}function x(){T("calibration-ready")}async function P(){try{T("calibration"),w.audioManager&&await w.audioManager.resume();const e=document.getElementById("calibration-instruction");e.textContent="Get ready... 3",await L(1e3),e.textContent="Get ready... 2",await L(1e3),e.textContent="Get ready... 1",await L(1e3),e.textContent="START SINGING! ðŸŽ¤",await L(500);const t=await w.startCalibration((t,i,s)=>{const n=w.pitchDetector.getLastResult(),o=n?.note?`â™ª ${n.note}`:"â™ª ...",a=n?.volume?Math.round(100*n.volume):0;e.textContent=`${s} | ${o} | Vol: ${a}%`});if(!t.success)throw new Error(t.message||"Calibration failed");T("game"),w.startChallenge(4,"normal"),w.on("pitch-update",e=>{M&&M.updateGameState({pitchData:e,targetNote:e.targetNote,holdProgress:e.holdProgress})}),w.on("note-hit",e=>{M&&M.updateGameState({noteResult:e.score.tier,score:e.score.totalPoints,combo:e.score.combo}),k&&(k.playNoteResult(e.score.tier),k.playCombo(e.score.combo));const t=document.getElementById("score-value");t&&(t.textContent=e.score.totalPoints);const i=document.getElementById("combo-value");i&&(i.textContent=e.score.combo)}),w.on("note-miss",()=>{M&&M.updateGameState({noteResult:"MISS"}),k&&k.playNoteResult("MISS")}),w.on("challenge-complete",e=>{T("results"),function(e){document.getElementById("final-grade").textContent=e.grade,document.getElementById("final-score").textContent=e.finalScore,document.getElementById("stats-display").innerHTML=`\n    <div>Perfect: ${e.statistics.perfectCount}</div>\n    <div>Great: ${e.statistics.greatCount}</div>\n    <div>OK: ${e.statistics.okCount}</div>\n    <div>Miss: ${e.statistics.missCount}</div>\n    <div>Max Combo: ${e.statistics.maxCombo}</div>\n    <div>Accuracy: ${e.statistics.accuracy}%</div>\n  `}(e),k&&k.playVictory(),function(e){const t=document.getElementById("status-announce");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},100))}(`Challenge complete! Grade: ${e.grade}`)}),w.on("challenge-failed",e=>{F(`Challenge failed: ${e.reason}`),k&&k.playFailure()})}catch(e){console.error("Failed to start challenge:",e),F(`Failed to start: ${e.message}`)}}function L(e){return new Promise(t=>setTimeout(t,e))}function B(){const e=document.getElementById("help-overlay");if(e){e.hasAttribute("hidden")?(e.removeAttribute("hidden"),e.focus()):e.setAttribute("hidden","")}}function N(e){const t=document.getElementById("hud");t&&(t.style.display=e?"flex":"none")}document.getElementById("start-button")?.addEventListener("click",()=>{k&&k.playClick(),x()}),document.getElementById("begin-calibration-button")?.addEventListener("click",()=>{k&&k.playClick(),P()}),document.getElementById("cancel-calibration-button")?.addEventListener("click",()=>{k&&k.playClick(),T("title-screen-layer"),I&&I.startLoop()}),document.getElementById("practice-button")?.addEventListener("click",()=>{k&&k.playClick(),console.log("Practice mode not yet implemented")}),document.getElementById("settings-button")?.addEventListener("click",()=>{k&&k.playClick(),console.log("Settings not yet implemented")}),document.getElementById("play-again-button")?.addEventListener("click",()=>{k&&k.playClick(),x()}),document.getElementById("menu-button")?.addEventListener("click",()=>{k&&k.playClick(),T("title-screen-layer"),I&&I.startLoop()}),document.getElementById("error-menu-button")?.addEventListener("click",()=>{k&&k.playClick(),T("title-screen-layer"),I&&I.startLoop()}),document.getElementById("retry-button")?.addEventListener("click",()=>{k&&k.playClick(),x()}),document.getElementById("pause-button")?.addEventListener("click",()=>{k&&k.playClick(),w&&w.pause()}),document.getElementById("close-help")?.addEventListener("click",()=>{k&&k.playClick(),B()}),async function(){try{console.log("Initializing Scale Climber...");if(!(window.AudioContext||window.webkitAudioContext))throw new Error("Web Audio API not supported in this browser");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Microphone access not supported in this browser");new r,console.log("Accessibility settings initialized"),k=new l,await k.waitForLoad(),console.log("Audio feedback initialized"),new c,console.log("Reference tone generator initialized"),w=new e,w.toggleMute=()=>k.toggleMute(),w.restart=()=>{x()};const o=document.getElementById("game-canvas");M=new t(o);const d=new i,h=new s,u=new n;M.setComponents({character:d,pitchMeter:h,particleSystem:u}),new a(w,{onHelp:B,onHUDToggle:N}),console.log("Keyboard controls initialized"),I=new E(w),I.init("title-screen-layer",()=>{x()}),console.log("Scale Climber initialized successfully"),setTimeout(()=>{T("title-screen-layer"),document.getElementById("loading-screen").classList.remove("active")},500)}catch(o){console.error("Failed to initialize app:",o),F(`Failed to initialize: ${o.message}`)}}(),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/scale-climber/sw.js").then(e=>{console.log("Service Worker registered:",e.scope),setInterval(()=>{e.update()},36e5),e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&function(){const e=document.createElement("div");e.id="update-banner",e.className="update-banner",e.setAttribute("role","alert"),e.setAttribute("aria-live","assertive"),e.innerHTML='\n    <div class="update-banner-content">\n      <p>ðŸŽµ A new version is available!</p>\n      <button id="update-btn" class="primary-button">Update Now</button>\n      <button id="dismiss-update" class="text-button">Later</button>\n    </div>\n  ',document.body.appendChild(e),document.getElementById("update-btn")?.addEventListener("click",()=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SKIP_WAITING"})}),document.getElementById("dismiss-update")?.addEventListener("click",()=>{e.remove()})}()})})}).catch(e=>{console.error("Service Worker registration failed:",e)});let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())})});
