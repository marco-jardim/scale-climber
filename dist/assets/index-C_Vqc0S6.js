import{G as e}from"./game-logic-VRbJBiwh.js";import{C as t,a as o,P as i,b as n}from"./visuals-DAVB2UIO.js";import"./audio-Ce-gjsOr.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const s={Tab:"navigate",Enter:"confirm"," ":"pause",Escape:"back",r:"restart",R:"restart",m:"mute",M:"mute",h:"toggleHUD",H:"toggleHUD",1:"octave1",2:"octave2",3:"octave3",4:"octave4",p:"practice",P:"practice","?":"help"};class a{constructor(e,t={}){this.gameEngine=e,this.enabled=!0,this.helpVisible=!1,this.hudVisible=!0,this.callbacks={onHelp:t.onHelp||null,onHUDToggle:t.onHUDToggle||null},this.setupListeners()}setupListeners(){document.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){if(!this.enabled)return;const t=s[e.key];t&&("Tab"!==e.key&&e.preventDefault(),this.handleAction(t,e))}handleAction(e,t){const o=this.gameEngine?.state||"idle";switch(e){case"pause":"playing"===o?(this.gameEngine.pause(),this.announceToScreenReader("Game paused")):"paused"===o&&(this.gameEngine.resume(),this.announceToScreenReader("Game resumed"));break;case"back":"playing"===o&&(this.gameEngine.pause(),this.announceToScreenReader("Game paused"));break;case"restart":"paused"!==o&&"results"!==o&&"failed"!==o||(this.gameEngine.restart(),this.announceToScreenReader("Restarting game"));break;case"mute":const t=this.gameEngine.toggleMute();this.announceToScreenReader(t?"Audio muted":"Audio unmuted");break;case"toggleHUD":this.hudVisible=!this.hudVisible,this.callbacks.onHUDToggle&&this.callbacks.onHUDToggle(this.hudVisible),this.announceToScreenReader(this.hudVisible?"HUD shown":"HUD hidden");break;case"help":this.helpVisible=!this.helpVisible,this.callbacks.onHelp&&this.callbacks.onHelp(this.helpVisible);break;case"practice":if("idle"===o||"menu"===o){const e=document.getElementById("practice-button");e&&e.click()}break;case"octave1":case"octave2":case"octave3":case"octave4":const i=e.slice(-1);this.handleOctaveSelect(i)}}handleOctaveSelect(e){console.log(`Octave ${e} selected`)}announceToScreenReader(e){const t=document.getElementById("status-announce")||this.createAnnouncer();t.textContent="",setTimeout(()=>{t.textContent=e},100)}createAnnouncer(){const e=document.createElement("div");return e.id="status-announce",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",document.body.appendChild(e),e}enable(){this.enabled=!0}disable(){this.enabled=!1}getHelpText(){return[{key:"Space",action:"Pause/Resume",description:"Toggle game pause"},{key:"Esc",action:"Back",description:"Pause game or go back"},{key:"R",action:"Restart",description:"Restart current challenge"},{key:"M",action:"Mute",description:"Toggle audio mute"},{key:"H",action:"Toggle HUD",description:"Show/hide game overlay"},{key:"P",action:"Practice",description:"Start practice mode"},{key:"1-4",action:"Select Octave",description:"Quick octave selection"},{key:"?",action:"Help",description:"Show/hide this help"},{key:"Tab",action:"Navigate",description:"Move focus to next element"},{key:"Enter",action:"Confirm",description:"Activate focused button"}]}destroy(){document.removeEventListener("keydown",this.handleKeyDown)}}class r{constructor(){this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.loadSettings(),this.setupMediaQueryListeners()}setupMediaQueryListeners(){const e=window.matchMedia("(prefers-reduced-motion: reduce)");e.addEventListener?e.addEventListener("change",e=>{this.prefersReducedMotion=e.matches,this.applySettings()}):e.addListener(e=>{this.prefersReducedMotion=e.matches,this.applySettings()})}loadSettings(){try{const e=JSON.parse(localStorage.getItem("accessibility_settings"));e&&(this.highContrastMode=e.highContrast||!1,this.colorblindMode=e.colorblindMode||"none",this.focusVisible=!1!==e.focusVisible)}catch{}this.applySettings()}saveSettings(){try{localStorage.setItem("accessibility_settings",JSON.stringify({highContrast:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}))}catch(e){console.warn("Failed to save accessibility settings:",e)}this.applySettings()}applySettings(){document.body.classList.toggle("reduced-motion",this.prefersReducedMotion),document.body.classList.toggle("high-contrast",this.highContrastMode),document.body.dataset.colorblindMode=this.colorblindMode,document.body.classList.toggle("focus-visible",this.focusVisible),this.emit("settingsChanged",this.getSettings())}getSettings(){return{prefersReducedMotion:this.prefersReducedMotion,highContrastMode:this.highContrastMode,colorblindMode:this.colorblindMode,focusVisible:this.focusVisible}}toggleHighContrast(){return this.highContrastMode=!this.highContrastMode,this.saveSettings(),this.highContrastMode}setColorblindMode(e){["none","deuteranopia","protanopia","tritanopia"].includes(e)?(this.colorblindMode=e,this.saveSettings()):console.warn(`Invalid colorblind mode: ${e}`)}getAdjustedColor(e){if("none"===this.colorblindMode&&!this.highContrastMode)return e;if(this.highContrastMode){return{perfect:"#00FF00",great:"#FFFF00",good:"#FFA500",ok:"#FF6600",miss:"#FF0000"}[e]||e}const t={deuteranopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#FF0066"},protanopia:{perfect:"#0088FF",great:"#FFDD00",good:"#FF8800",ok:"#FF6600",miss:"#8800FF"},tritanopia:{perfect:"#FF00FF",great:"#00FFFF",good:"#FF8800",ok:"#FF6600",miss:"#FF0000"}}[this.colorblindMode];return t&&t[e]||e}shouldReduceMotion(){return this.prefersReducedMotion}emit(e,t){const o=new CustomEvent(`accessibility:${e}`,{detail:t});document.dispatchEvent(o)}on(e,t){document.addEventListener(`accessibility:${e}`,e=>{t(e.detail)})}getColorblindModeDescription(){return{none:"Standard colors",deuteranopia:"Red-green colorblindness (Deuteranopia)",protanopia:"Red-blind (Protanopia)",tritanopia:"Blue-yellow colorblindness (Tritanopia)"}[this.colorblindMode]||"Unknown"}reset(){this.highContrastMode=!1,this.colorblindMode="none",this.focusVisible=!0,this.saveSettings()}}class c{constructor(){this.sounds=new Map,this.volume=.7,this.muted=!1,this.loadingPromises=[],this.loadSounds()}async loadSounds(){const e={perfect:"/assets/sounds/perfect.opus",great:"/assets/sounds/great.opus",ok:"/assets/sounds/ok.opus",miss:"/assets/sounds/miss.opus",combo:"/assets/sounds/combo.opus",victory:"/assets/sounds/victory.opus",failure:"/assets/sounds/failure.opus",click:"/assets/sounds/click.opus"},t={perfect:this.createSilentAudio(),great:this.createSilentAudio(),ok:this.createSilentAudio(),miss:this.createSilentAudio(),combo:this.createSilentAudio(),victory:this.createSilentAudio(),failure:this.createSilentAudio(),click:this.createSilentAudio()};for(const[o,i]of Object.entries(e)){const e=this.loadSound(o,i,t[o]);this.loadingPromises.push(e)}return Promise.all(this.loadingPromises)}async loadSound(e,t,o){try{const i=new Audio;return i.volume=this.volume,i.preload="auto",new Promise(n=>{i.addEventListener("canplaythrough",()=>{this.sounds.set(e,i),n()}),i.addEventListener("error",()=>{console.warn(`Failed to load sound: ${e}, using silent fallback`),this.sounds.set(e,o),n()}),i.src=t})}catch(i){console.warn(`Failed to load sound: ${e}`,i),this.sounds.set(e,o)}}createSilentAudio(){const e=new Audio;return e.src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=",e.volume=0,e}play(e,t=1){if(this.muted)return;const o=this.sounds.get(e);if(o)try{const e=o.cloneNode();e.volume=this.volume*t,e.play().catch(e=>{console.debug("Failed to play sound:",e)})}catch(i){console.debug("Error playing sound:",i)}else console.warn(`Sound not found: ${e}`)}playNoteResult(e){const t={PERFECT:"perfect",GREAT:"great",OK:"ok",MISS:"miss"}[e];t&&this.play(t)}playCombo(e){e>0&&e%5==0&&this.play("combo",.8)}playClick(){this.play("click",.5)}playVictory(){this.play("victory",.9)}playFailure(){this.play("failure",.9)}setVolume(e){this.volume=Math.max(0,Math.min(1,e));for(const t of this.sounds.values())t.volume=this.volume}getVolume(){return this.volume}setMuted(e){this.muted=e}toggleMute(){return this.muted=!this.muted,this.muted}isMuted(){return this.muted}stopAll(){for(const e of this.sounds.values())e.pause(),e.currentTime=0}async waitForLoad(){return Promise.all(this.loadingPromises)}}class l{constructor(){this.audioContext=null,this.enabled=!1,this.volume=.3,this.oscillatorType="sine"}initialize(){if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;e?this.audioContext=new e:console.warn("Web Audio API not supported")}}playNote(e,t=500){if(this.enabled&&(this.audioContext||this.initialize(),this.audioContext))try{"suspended"===this.audioContext.state&&this.audioContext.resume();const o=this.audioContext.createOscillator(),i=this.audioContext.createGain();o.connect(i),i.connect(this.audioContext.destination),o.frequency.setValueAtTime(e,this.audioContext.currentTime),o.type=this.oscillatorType;const n=this.audioContext.currentTime,s=t/1e3;i.gain.setValueAtTime(0,n),i.gain.linearRampToValueAtTime(this.volume,n+.05),i.gain.setValueAtTime(this.volume,n+s-.1),i.gain.linearRampToValueAtTime(0,n+s),o.start(n),o.stop(n+s),o.addEventListener("ended",()=>{o.disconnect(),i.disconnect()})}catch(o){console.warn("Failed to play reference tone:",o)}}playNoteName(e,t=500){const o=this.noteToFrequency(e);o&&this.playNote(o,t)}async playSequence(e,t=100){if(this.enabled)for(const o of e)o.noteName?this.playNoteName(o.noteName,o.duration||500):o.frequency&&this.playNote(o.frequency,o.duration||500),await this.delay((o.duration||500)+t)}noteToFrequency(e){const t=e.match(/^([A-G])([#b]?)(\d)$/);if(!t)return console.warn(`Invalid note name: ${e}`),null;const[,o,i,n]=t;let s={C:-9,D:-7,E:-5,F:-4,G:-2,A:0,B:2}[o];return"#"===i&&(s+=1),"b"===i&&(s-=1),s+=12*(parseInt(n)-4),440*Math.pow(2,s/12)}enable(){this.enabled=!0,this.audioContext||this.initialize()}disable(){this.enabled=!1}toggle(){return this.enabled?this.disable():this.enable(),this.enabled}isEnabled(){return this.enabled}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}getVolume(){return this.volume}setOscillatorType(e){["sine","square","sawtooth","triangle"].includes(e)&&(this.oscillatorType=e)}delay(e){return new Promise(t=>setTimeout(t,e))}destroy(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}let d=null,u=null,h=null,m=null,g=null,p=null;const y={loading:document.getElementById("loading-screen"),start:document.getElementById("start-screen"),calibration:document.getElementById("calibration-screen"),game:document.getElementById("game-screen"),results:document.getElementById("results-screen"),error:document.getElementById("error-screen")};function b(e){Object.values(y).forEach(e=>e.classList.remove("active")),y[e]&&y[e].classList.add("active"),"game"===e&&u?u.start():u&&u.stop()}function v(e){document.getElementById("error-message").textContent=e,b("error")}async function f(){try{b("calibration");if(!(await d.startCalibration(e=>{document.getElementById("calibration-instruction").textContent=`Calibrating... ${Math.round(100*e)}%`})).success)throw new Error("Calibration failed");b("game"),d.startChallenge(4,"normal"),d.on("pitch-update",e=>{u&&u.updateGameState({pitchData:e,targetNote:e.targetNote,holdProgress:e.holdProgress})}),d.on("note-hit",e=>{u&&u.updateGameState({noteResult:e.score.tier,score:e.score.totalPoints,combo:e.score.combo}),g&&(g.playNoteResult(e.score.tier),g.playCombo(e.score.combo));const t=document.getElementById("score-value");t&&(t.textContent=e.score.totalPoints);const o=document.getElementById("combo-value");o&&(o.textContent=e.score.combo)}),d.on("note-miss",()=>{u&&u.updateGameState({noteResult:"MISS"}),g&&g.playNoteResult("MISS")}),d.on("challenge-complete",e=>{b("results"),function(e){document.getElementById("final-grade").textContent=e.grade,document.getElementById("final-score").textContent=e.finalScore,document.getElementById("stats-display").innerHTML=`\n    <div>Perfect: ${e.statistics.perfectCount}</div>\n    <div>Great: ${e.statistics.greatCount}</div>\n    <div>OK: ${e.statistics.okCount}</div>\n    <div>Miss: ${e.statistics.missCount}</div>\n    <div>Max Combo: ${e.statistics.maxCombo}</div>\n    <div>Accuracy: ${e.statistics.accuracy}%</div>\n  `}(e),g&&g.playVictory(),function(e){const t=document.getElementById("status-announce");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},100))}(`Challenge complete! Grade: ${e.grade}`)}),d.on("challenge-failed",e=>{v(`Challenge failed: ${e.reason}`),g&&g.playFailure()})}catch(e){console.error("Failed to start challenge:",e),v(`Failed to start: ${e.message}`)}}function C(){const e=document.getElementById("help-overlay");if(e){e.hasAttribute("hidden")?(e.removeAttribute("hidden"),e.focus()):e.setAttribute("hidden","")}}function k(e){const t=document.getElementById("hud");t&&(t.style.display=e?"flex":"none")}document.getElementById("start-button")?.addEventListener("click",()=>{g&&g.playClick(),f()}),document.getElementById("practice-button")?.addEventListener("click",()=>{g&&g.playClick(),console.log("Practice mode not yet implemented")}),document.getElementById("settings-button")?.addEventListener("click",()=>{g&&g.playClick(),console.log("Settings not yet implemented")}),document.getElementById("play-again-button")?.addEventListener("click",()=>{g&&g.playClick(),f()}),document.getElementById("menu-button")?.addEventListener("click",()=>{g&&g.playClick(),b("start")}),document.getElementById("error-menu-button")?.addEventListener("click",()=>{g&&g.playClick(),b("start")}),document.getElementById("retry-button")?.addEventListener("click",()=>{g&&g.playClick(),b("start")}),document.getElementById("pause-button")?.addEventListener("click",()=>{g&&g.playClick(),d&&d.pause()}),document.getElementById("close-help")?.addEventListener("click",()=>{g&&g.playClick(),C()}),async function(){try{console.log("Initializing Scale Climber...");if(!(window.AudioContext||window.webkitAudioContext))throw new Error("Web Audio API not supported in this browser");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Microphone access not supported in this browser");m=new r,console.log("Accessibility settings initialized"),g=new c,await g.waitForLoad(),console.log("Audio feedback initialized"),p=new l,console.log("Reference tone generator initialized"),d=new e;const s=await d.initialize();if(!s.success)throw new Error(s.error||"Failed to initialize game engine");d.toggleMute=()=>g.toggleMute(),d.restart=()=>{b("start")};const y=document.getElementById("game-canvas");u=new t(y);const v=new o,f=new i,E=new n;u.setComponents({character:v,pitchMeter:f,particleSystem:E}),h=new a(d,{onHelp:C,onHUDToggle:k}),console.log("Keyboard controls initialized"),console.log("Scale Climber initialized successfully"),setTimeout(()=>{b("start")},500)}catch(s){console.error("Failed to initialize app:",s),v(`Failed to initialize: ${s.message}`)}}(),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/scale-climber/sw.js").then(e=>{console.log("Service Worker registered:",e.scope),setInterval(()=>{e.update()},36e5),e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&navigator.serviceWorker.controller&&function(){const e=document.createElement("div");e.id="update-banner",e.className="update-banner",e.setAttribute("role","alert"),e.setAttribute("aria-live","assertive"),e.innerHTML='\n    <div class="update-banner-content">\n      <p>ðŸŽµ A new version is available!</p>\n      <button id="update-btn" class="primary-button">Update Now</button>\n      <button id="dismiss-update" class="text-button">Later</button>\n    </div>\n  ',document.body.appendChild(e),document.getElementById("update-btn")?.addEventListener("click",()=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SKIP_WAITING"})}),document.getElementById("dismiss-update")?.addEventListener("click",()=>{e.remove()})}()})})}).catch(e=>{console.error("Service Worker registration failed:",e)});let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(e=!0,window.location.reload())})});
