class t{constructor(){this.frameTimes=[],this.maxSamples=60,this.qualityLevel="high",this.thresholds={high:16.6,medium:20,low:33.3},this.listeners=new Map,this.isMonitoring=!1,this.lastFrameTime=0}start(){this.isMonitoring=!0,this.lastFrameTime=performance.now()}stop(){this.isMonitoring=!1,this.frameTimes=[]}recordFrame(t,e){if(!this.isMonitoring)return;const i=e-t;this.frameTimes.push(i),this.frameTimes.length>this.maxSamples&&this.frameTimes.shift(),this.frameTimes.length===this.maxSamples&&this.adjustQuality()}adjustQuality(){const t=this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length,e=this.qualityLevel;t>this.thresholds.medium&&"high"===this.qualityLevel?(this.qualityLevel="medium",console.warn(`Reducing quality to medium (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"medium",avgFrameTime:t})):t>this.thresholds.low&&"medium"===this.qualityLevel?(this.qualityLevel="low",console.warn(`Reducing quality to low (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"low",avgFrameTime:t})):t<.9*this.thresholds.high&&"medium"===this.qualityLevel?(this.qualityLevel="high",console.log(`Improving quality to high (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"high",avgFrameTime:t})):t<.9*this.thresholds.medium&&"low"===this.qualityLevel&&(this.qualityLevel="medium",console.log(`Improving quality to medium (avg frame time: ${t.toFixed(2)}ms)`),this.emit("qualityChanged",{from:e,to:"medium",avgFrameTime:t})),this.frameTimes=[]}getQualityLevel(){return this.qualityLevel}setQualityLevel(t){if(["high","medium","low"].includes(t)){const e=this.qualityLevel;this.qualityLevel=t,this.frameTimes=[],this.emit("qualityChanged",{from:e,to:t,manual:!0})}}getQualitySettings(){return{high:{particlesEnabled:!0,particleCount:50,shadowsEnabled:!0,animationSmoothing:!0,backgroundLayers:3},medium:{particlesEnabled:!0,particleCount:25,shadowsEnabled:!1,animationSmoothing:!0,backgroundLayers:2},low:{particlesEnabled:!1,particleCount:0,shadowsEnabled:!1,animationSmoothing:!1,backgroundLayers:1}}[this.qualityLevel]}getStatistics(){if(0===this.frameTimes.length)return{avgFrameTime:0,minFrameTime:0,maxFrameTime:0,fps:0,qualityLevel:this.qualityLevel};const t=this.frameTimes.reduce((t,e)=>t+e,0)/this.frameTimes.length,e=Math.min(...this.frameTimes),i=Math.max(...this.frameTimes),s=1e3/t;return{avgFrameTime:Math.round(100*t)/100,minFrameTime:Math.round(100*e)/100,maxFrameTime:Math.round(100*i)/100,fps:Math.round(s),qualityLevel:this.qualityLevel,sampleCount:this.frameTimes.length}}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!this.listeners.has(t))return;const i=this.listeners.get(t),s=i.indexOf(e);s>-1&&i.splice(s,1)}emit(t,e){if(!this.listeners.has(t))return;this.listeners.get(t).forEach(i=>{try{i(e)}catch(s){console.error(`Error in PerformanceMonitor listener for ${t}:`,s)}})}reset(){this.frameTimes=[],this.qualityLevel="high"}}class e{constructor(e){this.canvas=e,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!1}),this.performanceMonitor=new t,this.isRendering=!1,this.renderLoopId=null,this.character=null,this.pitchMeter=null,this.particleSystem=null,this.gameState={currentNote:null,targetNote:null,pitchData:null,score:0,combo:0,noteResult:null},this.setupCanvas(),this.setupPerformanceMonitoring()}setupCanvas(){this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.parentElement,e=t.clientWidth,i=t.clientHeight,s=16/9;let h=e,a=h/s;a>i&&(a=i,h=a*s),this.canvas.style.width=`${h}px`,this.canvas.style.height=`${a}px`;const r=window.devicePixelRatio||1;this.canvas.width=h*r,this.canvas.height=a*r,this.ctx.scale(r,r),this.width=h,this.height=a}setupPerformanceMonitoring(){this.performanceMonitor.on("qualityChanged",t=>{console.log(`Quality changed: ${t.from} → ${t.to}`);const e=this.performanceMonitor.getQualitySettings();this.particleSystem&&(this.particleSystem.setEnabled(e.particlesEnabled),this.particleSystem.setMaxParticles(e.particleCount)),this.character&&this.character.setAnimationSmoothing(e.animationSmoothing)})}setComponents(t){this.character=t.character,this.pitchMeter=t.pitchMeter,this.particleSystem=t.particleSystem}updateGameState(t){this.gameState={...this.gameState,...t},this.character&&this.character.updateState(t),this.pitchMeter&&this.pitchMeter.updateState(t),this.particleSystem&&t.noteResult&&this.particleSystem.emitForResult(t.noteResult,this.width/2,this.height/2)}start(){this.isRendering=!0,this.performanceMonitor.start(),this.renderLoop()}stop(){this.isRendering=!1,this.performanceMonitor.stop(),this.renderLoopId&&(cancelAnimationFrame(this.renderLoopId),this.renderLoopId=null)}renderLoop(){if(!this.isRendering)return;const t=performance.now();this.ctx.clearRect(0,0,this.width,this.height),this.renderBackground(),this.character&&this.character.render(this.ctx,this.width,this.height),this.pitchMeter&&this.pitchMeter.render(this.ctx,this.width,this.height),this.particleSystem&&(this.particleSystem.update(),this.particleSystem.render(this.ctx)),this.renderHUD();const e=performance.now();this.performanceMonitor.recordFrame(t,e),this.renderLoopId=requestAnimationFrame(()=>this.renderLoop())}renderBackground(){const t=this.ctx.createLinearGradient(0,0,0,this.height);t.addColorStop(0,"#87CEEB"),t.addColorStop(1,"#E0F6FF"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height);this.performanceMonitor.getQualitySettings().backgroundLayers>=2&&this.renderMountains()}renderMountains(){this.ctx.fillStyle="#8B7BB8",this.ctx.globalAlpha=.3,this.ctx.beginPath(),this.ctx.moveTo(0,this.height),this.ctx.lineTo(.3*this.width,.6*this.height),this.ctx.lineTo(.5*this.width,this.height),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(.4*this.width,this.height),this.ctx.lineTo(.7*this.width,.5*this.height),this.ctx.lineTo(this.width,this.height),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=1}renderHUD(){const t=20;this.ctx.font="20px sans-serif",this.ctx.fillStyle="#2C3E50",this.ctx.textAlign="left",this.ctx.fillText(`Score: ${this.gameState.score}`,t,40),this.gameState.combo>0&&(this.ctx.fillStyle="#FFD700",this.ctx.fillText(`Combo: ${this.gameState.combo}x`,t,70));const e=this.performanceMonitor.getStatistics();this.ctx.textAlign="right",this.ctx.fillStyle="#7F8C8D",this.ctx.font="14px monospace",this.ctx.fillText(`${e.fps} FPS (${e.qualityLevel})`,this.width-t,34)}getPerformanceStats(){return this.performanceMonitor.getStatistics()}setQualityLevel(t){this.performanceMonitor.setQualityLevel(t)}destroy(){this.stop(),window.removeEventListener("resize",()=>this.resize())}}class i{constructor(){this.x=0,this.y=0,this.width=80,this.height=100,this.currentAnimation="idle",this.animationFrame=0,this.animationSpeed=.2,this.animationSmoothing=!0,this.noteProgress=0,this.lastNoteResult=null}updateState(t){t.noteResult&&(this.lastNoteResult=t.noteResult,"PERFECT"===t.noteResult||"GREAT"===t.noteResult?(this.currentAnimation="celebrating",setTimeout(()=>{this.currentAnimation="idle"},500)):"MISS"===t.noteResult&&(this.currentAnimation="stumbling",setTimeout(()=>{this.currentAnimation="idle"},500))),void 0!==t.holdProgress&&(this.noteProgress=t.holdProgress,this.noteProgress>0&&this.noteProgress<1&&(this.currentAnimation="climbing"))}render(t,e,i){switch(this.x=.3*e,this.y=.6*i,this.animationSmoothing&&(this.animationFrame+=this.animationSpeed,this.animationFrame>=4&&(this.animationFrame=0)),this.currentAnimation){case"climbing":this.renderClimbing(t);break;case"celebrating":this.renderCelebrating(t);break;case"stumbling":this.renderStumbling(t);break;default:this.renderIdle(t)}}renderIdle(t){const e=3*Math.sin(this.animationFrame);t.save(),t.translate(this.x,this.y+e),t.fillStyle="#20B2AA",t.beginPath(),t.arc(0,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"happy"),t.restore()}renderClimbing(t){const e=5*Math.sin(2*this.animationFrame);t.save(),t.translate(this.x,this.y),t.rotate(-.1),t.fillStyle="#20B2AA",t.beginPath(),t.arc(e,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"focused"),t.strokeStyle="#1A9B94",t.lineWidth=8,t.lineCap="round",t.beginPath(),t.moveTo(-15,-10),t.lineTo(-25,-30),t.stroke(),t.beginPath(),t.moveTo(15,-10),t.lineTo(25,-30),t.stroke(),t.restore()}renderCelebrating(t){const e=20*Math.abs(Math.sin(3*this.animationFrame));t.save(),t.translate(this.x,this.y-e);const i=1+.1*Math.sin(2*this.animationFrame);t.scale(i,i),t.fillStyle="#20B2AA",t.beginPath(),t.arc(0,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"excited"),t.strokeStyle="#1A9B94",t.lineWidth=8,t.lineCap="round",t.beginPath(),t.moveTo(-15,0),t.lineTo(-30,-20),t.stroke(),t.beginPath(),t.moveTo(15,0),t.lineTo(30,-20),t.stroke(),t.restore()}renderStumbling(t){const e=.3*Math.sin(5*this.animationFrame);t.save(),t.translate(this.x,this.y),t.rotate(e),t.fillStyle="#20B2AA",t.beginPath(),t.arc(0,0,this.width/2,0,2*Math.PI),t.fill(),this.renderFace(t,"worried"),t.restore()}renderFace(t,e){t.fillStyle="#2C3E50";const i=-5,s=12;"excited"===e?(t.beginPath(),t.arc(-12,i,4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(s,i,4,0,2*Math.PI),t.fill(),t.fillStyle="#FFD700",t.fillRect(-14,-11,2,2),t.fillRect(16,-11,2,2)):"worried"===e?(t.beginPath(),t.arc(-12,i,5,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(s,i,5,0,2*Math.PI),t.fill()):(t.beginPath(),t.arc(-12,i,3,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(s,i,3,0,2*Math.PI),t.fill()),t.strokeStyle="#2C3E50",t.lineWidth=2,t.lineCap="round",t.beginPath(),"excited"===e||"happy"===e?t.arc(0,5,12,.2,Math.PI-.2):"worried"===e?t.arc(0,15,12,Math.PI+.2,2*Math.PI-.2):(t.moveTo(-8,10),t.lineTo(8,10)),t.stroke()}setAnimationSmoothing(t){this.animationSmoothing=t}getCurrentAnimation(){return this.currentAnimation}}class s{constructor(){this.targetNote=null,this.currentFrequency=null,this.centDeviation=0,this.confidence=0,this.width=300,this.height=80,this.x=0,this.y=0}updateState(t){t.targetNote&&(this.targetNote=t.targetNote),t.pitchData&&(this.currentFrequency=t.pitchData.frequency,this.centDeviation=t.pitchData.cents||0,this.confidence=t.pitchData.confidence||0)}render(t,e,i){this.x=(e-this.width)/2,this.y=i-this.height-40,t.save(),t.translate(this.x,this.y),t.fillStyle="rgba(255, 255, 255, 0.9)",t.fillRect(0,0,this.width,this.height),t.strokeStyle="#2C3E50",t.lineWidth=2,t.strokeRect(0,0,this.width,this.height),this.targetNote&&(t.fillStyle="#2C3E50",t.font="bold 18px sans-serif",t.textAlign="center",t.fillText(`Target: ${this.targetNote}`,this.width/2,25)),this.renderCentMeter(t),this.confidence>0&&this.renderConfidence(t),t.restore()}renderCentMeter(t){const e=40,i=20,s=this.width/2;t.fillStyle="#E0E0E0",t.fillRect(20,e,this.width-40,i),t.strokeStyle="#2C3E50",t.lineWidth=2,t.beginPath(),t.moveTo(s,e),t.lineTo(s,60),t.stroke();const h=(this.width-40)/100,a=10*h;t.fillStyle="rgba(255, 215, 0, 0.3)",t.fillRect(s-a,e,2*a,i);const r=25*h;if(t.fillStyle="rgba(50, 205, 50, 0.2)",t.fillRect(s-r,e,2*r,i),this.confidence>.5){const e=s+Math.max(-50,Math.min(50,this.centDeviation))*h;let i="#FF4444";Math.abs(this.centDeviation)<=10?i="#FFD700":Math.abs(this.centDeviation)<=25?i="#32CD32":Math.abs(this.centDeviation)<=50&&(i="#00BFFF"),t.fillStyle=i,t.beginPath(),t.arc(e,50,8,0,2*Math.PI),t.fill(),t.fillStyle="#2C3E50",t.font="12px monospace",t.textAlign="center",t.fillText(`${this.centDeviation>0?"+":""}${Math.round(this.centDeviation)}¢`,e,35)}t.strokeStyle="#7F8C8D",t.lineWidth=1;for(let n=-50;n<=50;n+=10){const e=s+n*h;t.beginPath(),t.moveTo(e,60),t.lineTo(e,63),t.stroke(),0!==n&&(t.fillStyle="#7F8C8D",t.font="10px sans-serif",t.textAlign="center",t.fillText(`${n}`,e,75))}}renderConfidence(t){const e=this.width-50-10;t.fillStyle="#E0E0E0",t.fillRect(e,10,50,10);const i=50*this.confidence;t.fillStyle=this.confidence>.7?"#32CD32":"#FFA500",t.fillRect(e,10,i,10),t.fillStyle="#7F8C8D",t.font="10px sans-serif",t.textAlign="right",t.fillText("Conf.",e-5,20)}reset(){this.currentFrequency=null,this.centDeviation=0,this.confidence=0}}class h{constructor(t,e,i){this.x=t,this.y=e,this.vx=8*(Math.random()-.5),this.vy=8*(Math.random()-.5)-2,this.life=1,this.decay=.02*Math.random()+.01,this.size=6*Math.random()+2,this.color=i,this.gravity=.2}update(){return this.x+=this.vx,this.y+=this.vy,this.vy+=this.gravity,this.life-=this.decay,this.life>0}render(t){t.save(),t.globalAlpha=this.life,t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.size,0,2*Math.PI),t.fill(),t.restore()}}class a{constructor(){this.particles=[],this.maxParticles=50,this.enabled=!0}emitForResult(t,e,i){if(!this.enabled)return;const s={PERFECT:"#FFD700",GREAT:"#32CD32",OK:"#00BFFF",MISS:"#FF4444"}[t]||"#FFFFFF",a=Math.min({PERFECT:30,GREAT:20,OK:10,MISS:5}[t]||0,this.maxParticles);for(let r=0;r<a;r++)this.particles.length<this.maxParticles&&this.particles.push(new h(e,i,s))}emit(t,e,i,s=10){if(this.enabled)for(let a=0;a<Math.min(s,this.maxParticles);a++)this.particles.length<this.maxParticles&&this.particles.push(new h(t,e,i))}update(){this.particles=this.particles.filter(t=>t.update())}render(t){this.enabled&&this.particles.forEach(e=>{e.render(t)})}setEnabled(t){this.enabled=t,t||(this.particles=[])}setMaxParticles(t){this.maxParticles=t,this.particles.length>t&&(this.particles=this.particles.slice(0,t))}clear(){this.particles=[]}getParticleCount(){return this.particles.length}}export{e as C,s as P,i as a,a as b};
